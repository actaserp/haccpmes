<html layout:decorate="~{layout_page}">

<th:block layout:fragment="content">
  <div class="layout-contents">
    <div class="page-title-wrap">
      <div class="left">
        <h2>ê²€ì‚¬ì¼ë³´</h2>
        <a title="ë¶ë§ˆí¬" class="bookmark toggle">
          ë‚´ ë©”ë‰´
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ê²€ì‚¬ê´€ë¦¬</li>
        <li>ê²€ì‚¬ì¼ë³´</li>
      </ul>
    </div>

    <section class="section">
      <div class="section-top">
        <div class="search-wrap">
          <dl>
            <dt>
              <label>ì¡°íšŒì›”</label>
            </dt>
            <dd>
              <div class="srch-box">
                <input type="month" class="form-control2" id="SearchDate" name="SearchDate">
              </div>
            </dd>
          </dl>

          <dl>
            <dt>
              <label>ë¼ì¸</label>
            </dt>
            <dd>
              <div class="srch-box">
                <select id="WorkCenter_id" name="WorkCenter_id"></select>
              </div>
            </dd>
          </dl>

          <dl>
            <dt><span class="eq"></span></dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                  ê²€ìƒ‰
                </a>
              </li>
            </dd>
          </dl>
        </div>
        <div class="button-wrap">
          <ul>
            <!--<li>
              <button type="button" class="btn-delete btn-danger" id="btnDel" title="ì‚­ì œ" style="width: 115px; height: 36px;"><i class="fas fa-trash">ì‚­ì œ</i></button>
            </li>-->
            <li>
              <button type="button" class="btn-edit btn-default" id="btnEdit" title="ìˆ˜ì •" style="width: 115px; height: 36px;"><i class="fas fa-edit"></i>ìˆ˜ì •</button>
            </li>
          </ul>
        </div>
      </div>
      <div class="container-fluid">
        <div id="theGrid" style=""></div>
      </div>
    </section>
  </div>

  <script type="text/x-tmpl" id="TestDailyEditTemplate">
    <style>
        input[readonly] {
          background-color: #EDEFF5 !important;
          cursor: not-allowed;
        }

    </style>
     <div class="content_wrap popup" id="div_excel_upload">
    <div class="table-wrap">
      <form id="TestDailyReportForm">
        <table class="write-table">
          <caption>ê²€ì‚¬ ìˆ˜ëŸ‰ ìˆ˜ì •</caption>
          <tbody>
          <tr>
            <th style="text-align: center">
              <label for="ProductionDate">ê²€ì‚¬ì¼</label>
            </th>
            <td>
              <input type="date" id="ProductionDate" name="ProductionDate">
            </td>
            <th style="text-align: center">
              <label for="WorkCenter">ì›Œí¬ì„¼í„°(ë¼ì¸)</label>
            </th>
            <td>
             <select id="WorkCenter" name="WorkCenter"></select>
            </td>
          </tr>
          <tr>
            <th style="text-align: center">
              <label for="WorkOrderNumber">ì‘ì—…ì§€ì‹œë²ˆí˜¸</label>
            </th>
            <td>
              <input type="text" id="WorkOrderNumber" name="WorkOrderNumber">
            </td>
            <th style="text-align: center">
              <label for="DefectType">ë¶ˆëŸ‰ìœ í˜•</label>
            </th>
            <td>
              <select id="DefectType" name="DefectType"></select>
            </td>
          </tr>
          <tr>
            <th style="text-align: center">
              <label for="total_prod_qty">ê²€ì‚¬ ì´ìˆ˜ëŸ‰</label>
            </th>
            <td>
              <input type="text" id="total_prod_qty" name="total_prod_qty">
            </td>
            <th style="text-align: center">
              <label for="defect_qty">ë¶ˆëŸ‰ ìˆ˜ëŸ‰</label>
            </th>
            <td>
              <input type="text" id="defect_qty" name="defect_qty">
            </td>
          </tr>
          <tr>
            <th style="text-align: center">
              <label for="total_prod_qty">ê²€ì‚¬ ì´ìˆ˜ëŸ‰</label>
            </th>
            <td>
              <textarea name="total_prod_qty" id="total_prod_qty"></textarea>
              <te type="text" id="total_prod_qty" name="total_prod_qty">
            </td>
            <th style="text-align: center">
              <label for="defect_qty">ë¶ˆëŸ‰ ìˆ˜ëŸ‰</label>
            </th>
            <td>
              <input type="text" id="defect_qty" name="defect_qty">
            </td>
          </tr>

        </table>
      </form>
    </div>
    <div class="popup-button">
      <button type="button" class="btn-popup y_write_auth" id="btnPopTestDailySave">ìˆ˜ì •</button>
      <button type="button" class="btn-popup" id="modal-close-button">ë‹«ê¸°</button>
    </div>
  </script>
</th:block>

<th:block layout:fragment="scripts">
  <script type="text/javascript">
    class TestDailyReportPage {
      constructor() {
        this.grid = null;
        this.$btnEdit = $('#btnEdit');
        this.viewData = new wijmo.collections.CollectionView();
        this.url = '/api/test/test_daily_report';
        this.init();
      }

      init() {
        let _this = this;

        const yyyymm = $('#SearchDate').val(); // "2025-08"
        if (!yyyymm) return;

        const [year, month] = yyyymm.split('-').map(Number);

        const fixedColumns = [
          { binding: 'defect_type', header: 'ë¶ˆëŸ‰ëª…', width: 120, align: 'left' },
          { binding: 'defect_pk', header: 'ë¶ˆëŸ‰id',width: 120, align: 'left', visible: false },
        ];
        const dayColumns = getDayColumnsByMonth(year, month);
        const allColumns = [...fixedColumns, ...dayColumns];

        // âœ… ê¸°ì¡´ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ dispose
        const oldGrid = wijmo.Control.getControl('#theGrid');
        if (oldGrid) oldGrid.dispose();

        // âœ… ìƒˆë¡œ ê·¸ë¦¬ë“œ ìƒì„±
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          //selectionMode: wijmo.grid.SelectionMode.Row,
          selectionMode: wijmo.grid.SelectionMode.Cell,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          frozenColumns: 1,
          isReadOnly: true,
          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              const col = sender.columns[e.col];
              const header = col.header;

              e.cell.style.textAlign = 'center';

              if (/^\d+$/.test(header)) {
                const day = parseInt(header);
                const yyyymm = $('#SearchDate').val(); // "2025-08"
                const [year, month] = yyyymm.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const isoDate = formatDateToYYYYMMDD(date);

                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isHoliday = holidayList.includes(isoDate); // âœ… ì •í™•íˆ ë¹„êµ

                if (isHoliday || isWeekend) {
                  e.cell.style.color = 'red';
                  e.cell.style.backgroundColor = '#ffecec';
                } else {
                  e.cell.style.color = 'blue';
                  e.cell.style.backgroundColor = '#ecf5ff';
                }
              }
            }
          },
          columns: allColumns,
          itemsSource: this.viewData,
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = 'ê²€ì‚¬ì¼ë³´';

        // âœ… 1. Footer í–‰ ì´ˆê¸°í™” ë° ìƒì„±
        this.grid.columnFooters.rows.clear(); // ê¸°ì¡´ footer ì´ˆê¸°í™”
        this.grid.columnFooters.rows.push(new wijmo.grid.Row()); // ê²€ì‚¬ìˆ˜ row
        this.grid.columnFooters.rows.push(new wijmo.grid.Row()); // ë¶ˆëŸ‰ìˆ˜ row
        this.grid.columnFooters.rows.push(new wijmo.grid.Row()); // ppm row

// âœ… 2. footer ë‚´ìš© ì„¤ì • (ë°ì´í„° ë¡œë”© ì´í›„ ì²˜ë¦¬)
        this.grid.loadedRows.addHandler(() => {
          const footerPanel = this.grid.columnFooters;

          const rowTotalQty = footerPanel.rows[0];  // ê²€ì‚¬ìˆ˜
          const rowDefectQty = footerPanel.rows[1]; // ë¶ˆëŸ‰ìˆ˜
          const rowPpm = footerPanel.rows[2];       // ppm

          const totalQtyData = { defect_type: 'ê²€ì‚¬ìˆ˜' };
          const defectQtyData = { defect_type: 'ë¶ˆëŸ‰ìˆ˜' };
          const ppmData = { defect_type: 'ppm' };

          const dayColumns = this.grid.columns.filter(col => /^\d+$/.test(col.header));

          const seenDates = new Set(); // ë‚ ì§œ ì¤‘ë³µ ë°©ì§€

          dayColumns.forEach(col => {
            const field = col.binding; // ì˜ˆ: day_05

            let total = 0;
            let defect = 0;

            this.viewData.items.forEach(item => {
              const totalKey = `total_${field}`;
              const defectKey = field;

              const prodDate = item.ProductionDate || item.production_date || field;
              const key = `${prodDate}`; // ë‚ ì§œ ë‹¨ìœ„ ì¤‘ë³µ ë°©ì§€

              if (!seenDates.has(key) && item[totalKey] > 0) {
                total += item[totalKey];
                seenDates.add(key);
              }

              defect += item[defectKey] || 0;
            });

            const ppm = total > 0 ? Math.round((defect / total) * 1_000_000) : 0;

            totalQtyData[field] = total > 0 ? total : '-';
            defectQtyData[field] = defect > 0 ? defect : '-';
            ppmData[field] = ppm > 0 ? ppm : '-';
          });

          rowTotalQty.dataItem = totalQtyData;
          rowDefectQty.dataItem = defectQtyData;
          rowPpm.dataItem = ppmData;
        });


        this.grid.hostElement.addEventListener('dblclick', function (e) {
          let items = _this.grid.selectedItems;
          if (items.length === 0) {
            return false;
          }
          _this.$btnEdit.trigger('click');
        });

        this.$btnEdit.click(function (e) {
          const grid = _this.grid;
          const selectedCell = grid.selection;

          if (!selectedCell || !selectedCell.isSingleCell) {
            Alert.alert('ì˜¤ë¥˜', 'ì…€ì„ í•˜ë‚˜ë§Œ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
          }

          const rowIndex = selectedCell.row;
          const colIndex = selectedCell.col;

          // âœ… í–‰ ìœ íš¨ì„± í™•ì¸
          if (rowIndex < 0 || rowIndex >= grid.rows.length) return;

          const row = grid.rows[rowIndex];
          const selected = row.dataItem;

          // âœ… í•„ìˆ˜ ë°ì´í„° í™•ì¸
          if (!selected || !selected.defect_pk) {
            Alert.alert('ì˜¤ë¥˜', 'ë¶ˆëŸ‰ëª… í–‰ì˜ ë‚ ì§œ ì…€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
          }

          const selectedCol = grid.columns[colIndex];
          const dayBinding = selectedCol.binding; // ì˜ˆ: day_15

          let day = null;

          if (/^day_\d+$/.test(dayBinding)) {
            day = dayBinding.split('_')[1].padStart(2, '0'); // "15"
          }

          if (!day) {
            Alert.alert('ì˜¤ë¥˜', 'ë‚ ì§œ ì…€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
          }

          const yyyymm = $('#SearchDate').val(); // "2025-08"
          const fullDate = `${yyyymm}-${day}`;   // "2025-08-15"

          const data = {
            WorkCenter_id: $('#WorkCenter_id').val(),
            SearchDate: fullDate,
            defect_pk: selected.defect_pk,
            action: 'detail'
          };

          const fnsuccess = function (result) {
            if (!result || !result.data) {
              Alert.alert('ì˜¤ë¥˜', 'ìƒì„¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            if ($('.popup:visible').length > 0) {
              return; // ì´ë¯¸ ì—´ë ¤ìˆë‹¤ë©´ ì¤‘ë³µìœ¼ë¡œ ì—´ì§€ ì•ŠìŒ
            }
            result.data.mode = 'edit';
            _this.showTestDailyReportForm(result.data);

          };

          AjaxUtil.getAsyncData(_this.url + '/detail', data, fnsuccess);
        });



        $('#WorkCenter_id').off('change').on('change', function () {
          _this.searchMainData();
        });


        function getDayColumnsByMonth(year, month) {
          const lastDay = new Date(year, month, 0).getDate();
          return Array.from({ length: lastDay }, (_, i) => ({
            binding: `day_${i + 1}`,
            header: `${i + 1}`,
            width: 80,
            align: 'right',
            allowSorting: false,
            format: 'n0',
          }));
        }
      }

      showTestDailyReportForm(data) {
        let _this = this;
        let content = tmpl('TestDailyEditTemplate', data);
        let $content = $(content);

        let modalContainer = null;
        if (data.mode === 'new') {
          modalContainer = new PopupDraggable('ê²€ì‚¬ì¼ë³´ ë“±ë¡');
        } else {
          modalContainer = new PopupDraggable('ê²€ì‚¬ì¼ë³´ ìˆ˜ì •');
        }
        //íŒì—…íƒ€ì´í‹€ ì„¤ì •
        let $popTitle = $content.find('#popTitle');
        if (data.mode === 'new') {
          $popTitle.text('ê²€ì‚¬ì¼ë³´ ë“±ë¡');
        } else {
          // ë°œì£¼ ìˆ˜ì •ì‹œ ì œí’ˆê·¸ë£¹ê³¼ ì œí’ˆì„ ìˆ˜ì •í•˜ê²Œ í•  ê²ƒ ì¸ì§€?
          $popTitle.text('ê²€ì‚¬ì¼ë³´ ìˆ˜ì •');
        }

        //ëª¨ë‹¬ í¬ê¸°
        modalContainer.open({width: 1100, height: 250, $content});

        let $btnPopSave = $content.find('#btnPopTestDailySave');
        let $workOrderNumber = $content.find('#WorkOrderNumber');
        let $productionDate = $content.find('#ProductionDate');
        let $workCenter = $content.find('#WorkCenter');
        let $defectQty = $content.find('#defect_qty');
        let $totalQty = $content.find('#total_prod_qty');
        let $defectType = $content.find('#DefectType');
        let $TestDaily = $content.find('#TestDailyReportForm')

        AjaxUtil.fillSelectOptions($defectType, 'defect_type','', false);
        AjaxUtil.fillSelectOptions($workCenter, 'workcenter', '', false);

        if (data.WorkCenter_id && !data.WorkCenter) {
          data.WorkCenter = data.WorkCenter_id;
        }
        if (data.defect_pk && !data.DefectType) {
          data.DefectType = data.defect_pk;
        }
        FormUtil.BindDataForm(data, $TestDaily);

        // âœ… 'defect_qty'ë¥¼ ì œì™¸í•œ ëª¨ë“  ì…ë ¥/ì„ íƒ ìš”ì†Œ ë¹„í™œì„±í™”
        $TestDaily.find('input, select').each(function () {
          const name = $(this).attr('name');

          if (name === 'defect_qty') {
            $(this).removeAttr('readonly').removeAttr('disabled');
          } else {
            if ($(this).is('input')) {
              $(this).attr('readonly', true);
            } else if ($(this).is('select')) {
              $(this).attr('disabled', true);
            }
          }
        });

      }

      //ê²€ì‚¬ì¼ë³´ ëª©ë¡ ì¡°íšŒ
      searchMainData() {
        let _this = this;
        let url = this.url + '/read';
        let data = {
          'WorkCenter_id': $('#WorkCenter_id').val(),
          'SearchDate': $('#SearchDate').val()
        };

        let fnsuccess = function (result) {
          if (!Array.isArray(result.data)) {
            _this.viewData.sourceCollection = [];
            return;
          }

          const rawData = result.data;

          const grouped = {};
          rawData.forEach(row => {
            // ë‚ ì§œì—ì„œ ì¼(day)ë§Œ ì¶”ì¶œ
            const day = new Date(row.ProductionDate).getDate(); // â† ë” ì•ˆì „í•œ ë°©ì‹
            const key = `${row.defect_type}_${row.defect_pk}`;

            if (!grouped[key]) {
              grouped[key] = {
                defect_type: row.defect_type,
                defect_pk: row.defect_pk
              };
            }

            // ëˆ„ì  ì²˜ë¦¬ (ê°™ì€ ë‚  ì¤‘ë³µ ë°ì´í„° ìˆì„ ê²½ìš° ëŒ€ë¹„)
            grouped[key][`day_${day}`] = (grouped[key][`day_${day}`] || 0) + row.defect_qty;
            grouped[key][`total_day_${day}`] = (grouped[key][`total_day_${day}`] || 0) + row.total_prod_qty;
          });

          const converted = Object.values(grouped);
          _this.viewData.sourceCollection = converted;
        };

        AjaxUtil.getAsyncData(url, data, fnsuccess);
      }
    }

    let holidayList = [];

    async function fetchHolidaysForYear(year) {
      return new Promise((resolve, reject) => {
        var xhr = new XMLHttpRequest();
        var url = 'http://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo';
        var queryParams = '?' + encodeURIComponent('serviceKey') + '=' + 'R3P3syhq6qRP0cz8mbV2J5t%2B32WwaSN9sH8ZW4k59oKAU3Ze0WvcljMrN36OJqxs38%2F780hMD4QfhCiDZQNUyA%3D%3D';
        queryParams += '&' + encodeURIComponent('solYear') + '=' + encodeURIComponent(year);
        queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('30');

        xhr.open('GET', url + queryParams);
        xhr.onreadystatechange = function () {
          if (this.readyState == 4) {
            if (this.status == 200) {
              var parser = new DOMParser();
              var xmlDoc = parser.parseFromString(this.responseText, "text/xml");

              // XMLì—ì„œ ì›í•˜ëŠ” ë°ì´í„° ì¶”ì¶œ
              var items = xmlDoc.getElementsByTagName("item");
              let holidays = [];
              for (var i = 0; i < items.length; i++) {
                var locdate = items[i].getElementsByTagName("locdate")[0].textContent;
                var dateName = items[i].getElementsByTagName("dateName")[0].textContent;

                holidays.push({date: locdate, name: dateName});
              }
              resolve(holidays);
            } else {
              console.error('ì˜¤ë¥˜ ë°œìƒ. HTTP ìƒíƒœ ì½”ë“œ:', this.status);
              reject(this.status);
            }
          }
        };

        xhr.send();
      });
    }
    async function initPage() {
      $('#SearchDate').val(CommonUtil.getYYYYMMDD().substring(0, 7));
      AjaxUtil.fillSelectOptions($('#WorkCenter_id'), 'workcenter', '', false);

      const yyyymm = $('#SearchDate').val();
      const [year] = yyyymm.split('-').map(Number);

      try {
        const holidaysRaw = await fetchHolidaysForYear(year);
        holidayList = holidaysRaw
          .filter(item => item.date && item.date.length === 8)
          .map(item => {
            const locdate = item.date;
            return `${locdate.substring(0, 4)}-${locdate.substring(4, 6)}-${locdate.substring(6, 8)}`;
          });

        //console.log('ğŸ“… ìµœì´ˆ ë¡œë”© holidayList:', holidayList);
      } catch (err) {
        console.error('âŒ ê³µíœ´ì¼ ë¡œë”© ì‹¤íŒ¨:', err);
        holidayList = [];
      }

      page = new TestDailyReportPage();
      page.searchMainData();
    }

    function formatDateToYYYYMMDD(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }


    let page = null;

    $(document).ready(function () {
      initPage();
      $('#SearchDate').val(CommonUtil.getYYYYMMDD().substring(0, 7));
      AjaxUtil.fillSelectOptions($('#WorkCenter_id'), 'workcenter', '', false);

      page = new TestDailyReportPage();
      page.searchMainData();

      $('#SearchDate').on('change', async function () {
        const yyyymm = $('#SearchDate').val(); // "2025-08"

        if (!yyyymm || !yyyymm.includes('-')) {
          console.warn('âš ï¸ ì¡°íšŒì›”ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', yyyymm);
          return;
        }

        const [year] = yyyymm.split('-').map(Number);

        try {
          const holidaysRaw = await fetchHolidaysForYear(year);
          holidayList = holidaysRaw
            .filter(item => item.date && item.date.length === 8)
            .map(item => {
              const locdate = item.date;
              return `${locdate.substring(0, 4)}-${locdate.substring(4, 6)}-${locdate.substring(6, 8)}`;
            });

          //console.log('ğŸ“… holidayList:', holidayList);

          page.init();
          page.searchMainData();

        } catch (err) {
          console.error('âŒ ê³µíœ´ì¼ ë¡œë”© ì‹¤íŒ¨:', err);
          holidayList = [];
          page.init();
          page.searchMainData();
        }
      });

      //ê²€ìƒ‰
      $('#btnSearch').click(function (e) {
        page.searchMainData();
      });

      $('#keyword').on('keypress', function (e) {
        if (event.keyCode == 13) {
          page.searchMainData();
        }
      });

      // ì‹ ê·œ
      $('#btnNew').click(function (e) {
        let id = null; // ID ê°’ ê°€ì ¸ì˜¤ê¸°
        page.showEditPage(id,'new')
      });

      // ì‚­ì œ
      $('#btnDel').click(function (e) {
        page.showEditPage('del');
      });
    });
  </script>
</th:block>
</html>