<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>
    #chartModal .modal-content {
        width: 80vw;
        height: 80vh;
        max-width: 800px;
        max-height: 600px;
    }

    #modalChartHolder {
        width: 100%;
        height: 100%;
    }

    /* KPI wrapper */
    .kpi-cardwrap{
        width:100%;
        display:flex;
        gap:12px;
        flex-wrap:wrap;
        padding:0;
    }

    /* KPI ì¹´ë“œ ê³µí†µ */
    .kpi-cardwrap section{
        flex:1;
        min-width:240px;
        background:#fff;
        border:1px solid #E5E7EC;     /* ê³µí†µì²˜ëŸ¼ ë³´ë”ëŠ” ì–‡ê²Œ */
        border-radius:14px;
        padding:14px 18px;
        box-shadow:none;
        transition:none;              /* hover í™•ëŒ€ ê°™ì€ ê±° ì œê±° */
    }

    .kpi-cardwrap section:hover{
        transform:none;
    }

    /* íƒ€ì´í‹€ */
    .kpi-cardwrap section .title{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:10px;
    }
    .kpi-cardwrap section .title h3{
        font-size:16px;
        font-weight:800;
        margin:0;
    }

    /* dl í•œ ì¤„ ë ˆì´ì•„ì›ƒ */
    .kpi-cardwrap section dl{
        display:flex;
        justify-content:space-between;
        align-items:baseline;
        margin:6px 0;
    }
    .kpi-cardwrap section dl dt{
        font-size:12px;
        color:#666;
        font-weight:600;
        white-space:nowrap;
    }
    .kpi-cardwrap section dl dd{
        display:flex;
        align-items:center;
        justify-content:flex-end;
        font-size:20px;     /* âœ… ê°’ í¬ê¸° */
        font-weight:800;
        margin:0;
        white-space:nowrap;
    }

    /* ë§ˆì§€ë§‰ ì¤„ë§Œ ë”°ë¡œ ì“°ê³  ì‹¶ìœ¼ë©´ */
    .kpi-cardwrap section dl:last-child dd{
        font-size:20px;
    }
    /* KPI ì¹´ë“œ ê³µí†µ: ë‚´ë¶€ë¥¼ ìœ„/ì¤‘ê°„/ì•„ë˜ë¡œ ìª¼ê°¤ ìˆ˜ ìˆê²Œ */
    .kpi-cardwrap section{
        display:flex;
        flex-direction:column;
        min-height:0;       /* âœ… ë‚´ë¶€ ìŠ¤í¬ë¡¤ ìœ„í•´ í•„ìš” */
    }
    /* íƒ€ì„ë¼ì¸ ì¹´ë“œ ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
    .kpi-cardwrap .timeline-section{
        display:flex;
        flex-direction:column;
    }

    .kpi-cardwrap .timeline-section #eventTimeline{
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto;      /* âœ… ì´ë ¥ ë§ì•„ë„ ì¹´ë“œ ì•ˆì—ì„œ ìŠ¤í¬ë¡¤ */
        max-height: 130px;   /* ì¹´ë“œ ë†’ì´ì— ë§ê²Œ ì¡°ì ˆ */
    }

    /* ì•ˆë‚´ë¬¸ì€ ë°”ë‹¥ì— ê³ ì • */
    .kpi-cardwrap .timeline-section .timeline-note{
        flex:0 0 auto;
        margin-top:6px;
        font-size:12px;
        color:#888;
    }
</style>
<th:block layout:fragment="content">
  <div class="layout-contents">

    <div class="page-title-wrap">
      <div class="left">
        <h2>ê³µì • ì§„í–‰ ëª¨ë‹ˆí„°ë§</h2>
        <a class="bookmark toggle" title="ë¶ë§ˆí¬">ë‚´ ë©”ë‰´</a>
      </div>
      <ul class="page-navi">
        <li><img alt="í™ˆì•„ì´ì½˜" src="/images/icon/ico-nav-home.svg"></li>
        <li>ëŒ€ì‹œë³´ë“œ</li>
        <li>ê³µì • ì§„í–‰ ëª¨ë‹ˆí„°ë§</li>
      </ul>
    </div>
    <div class="dashboard-wrap">
      <!-- (1) Header Bar (ì´ë¯¸ì§€ ìƒë‹¨ í° ë°” ëŠë‚Œ) -->
      <section class="wp100" style="margin-bottom:10px; border-radius:12px; padding:14px 18px; min-height: 50px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
          <div style="font-weight:700; font-size:16px;">
            <span class="greenText" id="hdr-run"><span>RUNNING</span></span> |
            <span id="hdr-mode">ìë™</span> |
            <span id="hdr-time"></span>
          </div>

          <div style="font-weight:600; color:#666;">
            í˜„ì¬ ë ˆì‹œí”¼ ì´ë¦„(ê¸°íŒ): <span id="hdr-job">temp.tsm</span>
          </div>

          <!-- ìš°ì¸¡ ì»¨íŠ¸ë¡¤: ì•Œë¦¼ + ì‹œê°„ -->
          <!--<div style="display:flex; align-items:center; gap:10px; position:relative;">
            &lt;!&ndash; ì•Œë¦¼ ë²„íŠ¼ &ndash;&gt;
            <button class="btn btn-popup" id="btnAlarmBell" style="position:relative;" type="button">
              ğŸ”” ì•Œë¦¼
              <span class="alarm-badge" id="alarmBadge" style="display:none;">0</span>
            </button>

            &lt;!&ndash; ì•Œë¦¼ íŒ¨ë„(ë“œë¡­ë‹¤ìš´) &ndash;&gt;
            <div class="alarm-panel" id="alarmPanel" style="display:none;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <div style="font-weight:700;">ì•Œë¦¼</div>
                <div style="display:flex; gap:6px; align-items:center;">
                  <select id="alarmFilter" style="height:28px;">
                    <option value="ALL">ì „ì²´</option>
                    <option value="DANGER">ìœ„í—˜</option>
                    <option value="WARN">ì£¼ì˜</option>
                    <option value="INFO">ì •ë³´</option>
                  </select>
                  <button class="btn btn-popup" id="btnAlarmClear" type="button">ì½ìŒ ì²˜ë¦¬</button>
                </div>
              </div>

              <div class="alarm-list" id="alarmList">
                &lt;!&ndash; JSë¡œ ì±„ì›€ &ndash;&gt;
                <div style="color:#888; padding:10px;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
              </div>
            </div>
          </div>-->

        </div>
      </section>

      <!-- (2) KPI ì¹´ë“œ -->
      <div class="row row-1" style="margin-bottom:10px;">
        <div class="card-wrap kpi-cardwrap"
             style="display:flex; gap:12px; width:100%; flex-wrap:wrap; padding:0;">
          <!-- 2) ìƒì‚° KPI -->
          <section class="request" style="flex:1; min-width:240px; border-radius:14px;">
            <div class="title"><h3>ìƒì‚° KPI</h3></div>
            <dl><dt>PPH</dt><dd id="kpi-pph">-</dd></dl>
            <dl><dt>Yield</dt><dd id="kpi-yield">-</dd></dl>
            <dl><dt>íˆ¬ì…/ìƒì‚°</dt><dd id="kpi-inout">-</dd></dl>
            <dl><dt>ê¸°íŒ ì •ì§€</dt><dd id="kpi-stop">-</dd></dl>
          </section>

          <!-- 3) HZ -->
          <section class="check" style="flex:1; min-width:240px; border-radius:14px;">
            <div class="title"><h3>HZ</h3></div>
            <dl><dt>Heat 1-6</dt><dd id="kpi-heat16">-</dd></dl>
            <dl><dt>Heat 7-10</dt><dd id="kpi-heat710">-</dd></dl>
            <dl><dt>Cool</dt><dd id="kpi-coolhz">-</dd></dl>
          </section>

          <!-- CM + PPM í†µí•© ì¹´ë“œ -->
          <section class="check" style="flex:1; min-width:240px; border-radius:14px;">
            <div class="title" style="display:flex; align-items:center; justify-content:space-between;">
              <h3>CM / PPM</h3>
              <!-- í•„ìš”í•˜ë©´ ìƒíƒœ ë±ƒì§€ ê°™ì€ ê²ƒë„ ê°€ëŠ¥ -->
              <!-- <span class="mini-badge">LIVE</span> -->
            </div>

            <div class="kpi-pair">
              <!-- CM -->
              <div class="kpi-box">
                <div class="kpi-subtitle">CM</div>

                <dl>
                  <dt>C/V Speed</dt>
                  <dd id="kpi-cvspeed">-</dd>
                </dl>

                <dl>
                  <dt>C/V WIDTH</dt>
                  <dd id="kpi-cvwidth">-</dd>
                </dl>
              </div>

              <!-- PPM -->
              <div class="kpi-box">
                <div class="kpi-subtitle">PPM</div>

                <dl>
                  <dt>N2 MODE</dt>
                  <dd>
                    <div class="kpi-n2pv">
                      <span class="pv" id="kpi-n2-pv">-</span>
                      <!-- <span class="mode" id="kpi-n2-mode">-</span> -->
                    </div>
                  </dd>
                </dl>
              </div>
            </div>
          </section>


          <!-- 6) ì•ŒëŒ íƒ€ì„ë¼ì¸ -->
          <section class="timeline-section"
                   style="flex:1; min-width:240px; border-radius:14px; max-height:190px;">
            <h5 style="margin-bottom:2px;">ì•ŒëŒ / ì´ìƒ ì¡°ì§ íƒ€ì„ë¼ì¸</h5>
            <div class="timeline-note" style="margin-bottom:2px;">
              * ì´ë²¤íŠ¸ í´ë¦­ ì‹œ í•´ë‹¹ ì‹œì ìœ¼ë¡œ Zone/Profile/ìƒì‚° ê·¸ë˜í”„ ë™ê¸°í™”
            </div>
            <div id="eventTimeline"><!-- JSë¡œ ì±„ì›€ --></div>
          </section>

        </div>
      </div>

      <!-- (3) ë³¸ë¬¸ 2ì—´ ê·¸ë¦¬ë“œ -->
      <div class="tab-row" style="display:flex; width:100%; gap:20px; margin-bottom:12px;">

        <!-- ì¢Œ: ì˜¨ë„ ë¦¬ìŠ¤í¬ ëª¨ë‹ˆí„° -->
        <section style="width:50%; min-height:260px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h5>ì˜¨ë„ ë¦¬ìŠ¤í¬ ëª¨ë‹ˆí„°</h5> <!--(í•µì‹¬)-->
            <span style="color:#888; font-size:12px;">Î”T Max / ZT-ZB / ìƒíƒœ</span>
          </div>

          <!-- ë¦¬ìŠ¤í¬ í…Œì´ë¸”(ìƒìœ„ 3ê°œë§Œ) -->
          <div style="margin-top:8px;">
            <table class="write-table" style="width:100%;">
              <thead>
              <tr>
                <th style="width:70px;">Zone</th>
                <th>Î”T Max</th>
                <th>ZT-ZB</th>
                <th style="width:90px;">ìƒíƒœ</th>
              </tr>
              </thead>
              <tbody id="riskTableBody">
              <!-- JSë¡œ ì±„ì›€ -->
              </tbody>
            </table>
          </div>

          <!-- Zone Î”T ë°” ì°¨íŠ¸ -->
          <div class="chart-wrap" style="justify-content: normal; position: relative; height: 140px; margin-top:10px;">
            <canvas id="zoneDtBarChart"></canvas>
            <span class="material-symbols-outlined"
                  onclick="openModal('zoneDtBarChart')"
                  style="position:absolute; top: 10px; right: 6px; cursor:pointer; z-index:10; color:#b3b3b3;">zoom_out_map</span>
          </div>
        </section>

        <!-- ìš°: Reflow Profile -->
        <section style="width:50%; min-height:260px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h5>Reflow ì˜¨ë„ ì¶”ì´ (ìµœê·¼ 30ë¶„)</h5><!--(ê·¸ë˜í”„)-->
            <span id="profileText" style="color:#888; font-size:12px;"></span>
          </div>

          <div class="chart-wrap" style="justify-content: normal; position: relative; height: 100%; margin-top:10px;">
            <canvas id="profileLineChart"></canvas>
            <span class="material-symbols-outlined"
                  onclick="openModal('profileLineChart')"
                  style="position:absolute; top: 10px; right: 6px; cursor:pointer; z-index:10; color:#b3b3b3;">zoom_out_map</span>
          </div>
        </section>
      </div>

      <!-- (4) 2ë²ˆì§¸ ì¤„ -->
      <div class="tab-row" style="display:flex; width:100%; gap:20px; margin-bottom:12px;">

        <!-- ì¢Œ: Zone ì„¤ì •/í‰ê· /í¸ì°¨ -->
        <section style="width:50%; min-height:240px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h5>Zone ì„¤ì • / í‰ê·  / í¸ì°¨</h5>
            <!--                    <button type="button" class="btn btn-popup" id="btnExpandZones">Z1~Z10 í¼ì¹˜ê¸°</button>-->
          </div>

          <div style="margin-top:8px; max-height:180px; overflow:auto;">
            <table class="write-table" style="width:100%;">
              <thead>
              <tr>
                <th style="width:70px;">Zone</th>
                <th style="text-align: center;">ì„¤ì •</th>
                <th style="text-align: center;">í‰ê· (í˜„ì¬)</th>
                <th style="text-align: center;">í¸ì°¨(Î”)</th>
              </tr>
              </thead>
              <tbody id="zoneTableBody">
              <!-- JSë¡œ ì±„ì›€ -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- ìš°: ìƒì‚° íë¦„/ì •ì§€ + ìµœê·¼30ë¶„ -->
        <section style="width:50%; min-height:240px; padding:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h5>ìµœê·¼ 30ë¶„ ìƒì‚° ì¶”ì´ & ì •ì§€ ì´ë²¤íŠ¸</h5> <!--ìƒì‚° íë¦„ & ì •ì§€ ê°ì‹œ-->
            <span id="stopCountText" style="color:#888; font-size:12px;"></span>
          </div>

          <div style="display:flex; gap:16px; margin-top:8px; align-items:flex-start; flex-wrap:wrap;">
            <div style="width:100%;">
              <div style="font-weight:700;"></div>
              <div style="margin-top:6px; font-size:14px;">
                íˆ¬ì… â–¶â–¶â–¶â–¶â–¶â–¶ ìƒì‚°
                <span id="flow-in" style="display:inline-block; min-width:60px; text-align:right; font-weight:700;">-</span>
                <span style="display:inline-block; width:30px;"></span>
                <span id="flow-out" style="display:inline-block; min-width:60px; text-align:right; font-weight:700;">-</span>
              </div>
            </div>

            <div class="chart-wrap"
                 style="flex:1; min-width:260px; justify-content: normal; position: relative; height: 170px;">
              <canvas id="prodTrendChart"></canvas>
              <span class="material-symbols-outlined"
                    onclick="openModal('prodTrendChart')"
                    style="position:absolute; top: 10px; right: 6px; cursor:pointer; z-index:10; color:#b3b3b3;">zoom_out_map</span>
            </div>
          </div>
        </section>
      </div>

    </div>

  </div>

  <!-- ê¸°ì¡´ ëª¨ë‹¬(ì¤Œ) ì¬ì‚¬ìš© ê°€ëŠ¥ -->
  <div class="modal" id="chartModal" style="opacity:100">
    <div class="modal-content">
      <span class="close">&times;</span>
      <canvas id="modalChartHolder" style="width: 1292px; height: 474px;"></canvas>
    </div>
  </div>

</th:block>

<th:block layout:fragment="scripts">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/js/nth-tabs.js"></script>
  <script type="text/javascript">
   class DashPage {
    constructor() {
     this.timer = null;
     this.url = '/api/dashboard/reflow';
     this.prevKpiSnapshot = null;

    }

    init() {
     this.bindHeaderTime();
     this.searchReflowLog();     // ìµœì´ˆ 1íšŒ
     this.startPolling();        // 30ì´ˆ í´ë§
     this.startChartTicker();    //
    }//init

    bindHeaderTime() {
     const $hdrTime = $('#hdr-time');
     if ($hdrTime.length === 0) return;

     const pad2 = (n) => String(n).padStart(2, '0');

     const formatNow = () => {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = pad2(d.getMonth() + 1);
      const dd = pad2(d.getDate());
      const hh = pad2(d.getHours());
      const mi = pad2(d.getMinutes());
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
     };

     const render = () => {
      $hdrTime.text(formatNow());
     };

     render(); // ì²˜ìŒ 1íšŒ
     clearInterval(this.timer);
     this.timer = setInterval(render, 1000); // 1ì´ˆë§ˆë‹¤ ê°±ì‹  (í‘œì‹œëŠ” ë¶„ê¹Œì§€ë§Œ)
    }//bindHeaderTime

    startPolling() {
     clearInterval(this.pollTimer);
     this.pollTimer = setInterval(() => {
      // íƒ­ ë¹„í™œì„±ì´ë©´ ìŠ¤í‚µ
      if (document.hidden) return;
      this.searchReflowLog();
     }, 15 * 1000);
    }

    startChartTicker() {
     clearInterval(this.chartTimer);

     const pad2 = (n) => String(n).padStart(2, '0');

     const tick = () => {
      if (document.hidden) return;
      if (!this._lastRows || !this._lastRows.length) return;

      const now = new Date();
      const minuteKey =
       `${now.getFullYear()}-${pad2(now.getMonth() + 1)}-${pad2(now.getDate())} ` +
       `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;

      const minuteChanged = (this._lastChartMinuteKey !== minuteKey);
      this._lastChartMinuteKey = minuteKey;

      const nowMs = now.getTime();
      const due = (!this._lastChartUpdateAt || (nowMs - this._lastChartUpdateAt >= 15 * 1000));

      if (minuteChanged || due) {
       this._lastChartUpdateAt = nowMs;

       // âœ… now ê¸°ì¤€ rolling ì°¨íŠ¸ ê°±ì‹ 
       this.bindProfileChartRolling(this._lastRows);
      }
     };

     tick();
     this.chartTimer = setInterval(tick, 15 * 1000);
    }//startChartTicker

    bindProfileChartRolling(rows) {
     if (!rows || !rows.length) return;

     // âœ… í˜„ì¬ì‹œê°„ ê¸°ì¤€ (ë ë¼ë²¨ = now)
     const now = new Date();
     now.setSeconds(0, 0);                 // âœ… ë¶„ ì •ê°

     const stepMs = 60 * 1000;             // 1ë¶„ ë²„í‚·
     const windowMs = 30 * 60 * 1000;      // 30ë¶„
     const start = new Date(now.getTime() - windowMs);
     start.setSeconds(0, 0);               // âœ… ë¶„ ì •ê°

     const bucketCount = Math.floor((now.getTime() - start.getTime()) / stepMs) + 1;

     const buckets = Array.from({ length: bucketCount }, (_, i) => ({
      t: new Date(start.getTime() + i * stepMs),
      value: null
     }));

     // rows â†’ ë²„í‚· ë§¤í•‘
     for (const row of rows) {
      const tRaw = this.parseKpiTime(row["ë‚  ì§œ"]);
      if (!tRaw) continue;

      const t = new Date(tRaw);
      t.setSeconds(0, 0);                 // âœ… rowë„ ë¶„ ì •ê°

      const ms = t.getTime();
      if (ms < start.getTime() || ms > now.getTime()) continue;

      const zs = this.extractZones(row);
      if (!zs || !zs.length) continue;

      const avgArr = zs.map(z => z.avgCur).filter(v => v != null);
      if (!avgArr.length) continue;

      const avgTemp = avgArr.reduce((a, b) => a + b, 0) / avgArr.length;

      // âœ… idxëŠ” floor (round ê¸ˆì§€)
      const idx = Math.floor((ms - start.getTime()) / stepMs);
      if (idx >= 0 && idx < buckets.length) {
       buckets[idx].value = Number(avgTemp.toFixed(2));
      }
     }

     // labels/data
     const lbl2 = buckets.map(b => {
      const hh = String(b.t.getHours()).padStart(2, '0');
      const mm = String(b.t.getMinutes()).padStart(2, '0');
      return `${hh}:${mm}`;
     });
     const data2 = buckets.map(b => b.value);

     // profileText
     const validVals = data2.filter(v => v != null);
     if (validVals.length) {
      const mean = validVals.reduce((a, b) => a + b, 0) / validVals.length;
      const minv = Math.min(...validVals);
      const maxv = Math.max(...validVals);
      $('#profileText').text(`ìµœê·¼30ë¶„ í‰ê·  ${mean.toFixed(1)}â„ƒ (min ${minv.toFixed(1)} / max ${maxv.toFixed(1)})`);
     } else {
      $('#profileText').text('ìµœê·¼30ë¶„ ë°ì´í„° ì—†ìŒ');
     }

     // chart
     const ctx2 = document.getElementById('profileLineChart');
     if (!ctx2 || !window.Chart) return;

     if (!this._chartProfile) {
      this._chartProfile = new Chart(ctx2, {
       type: 'line',
       data: {
        labels: lbl2,
        datasets: [{
         label: 'Zone í‰ê· ì˜¨ë„(ì‹¤ì¸¡)',
         data: data2,
         spanGaps: false,
         pointRadius: 0,
         tension: 0.25
        }]
       },
       options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
       }
      });
     } else {
      // âœ… destroy í•˜ì§€ ë§ê³  ë°ì´í„°ë§Œ ê°±ì‹  (ê°€ë²¼ì›€)
      this._chartProfile.data.labels = lbl2;
      this._chartProfile.data.datasets[0].data = data2;
      this._chartProfile.update('none');
     }
    }

    // âœ… ì˜¤ëŠ˜ ë‚ ì§œ(mm-dd) + í˜„ì¬ ë¶„(minute) ê¸°ì¤€ìœ¼ë¡œ ë¡œê·¸ ì¡°íšŒ
    searchReflowLog() {
     let _this = this;

     if (_this.loading) return;
     _this.loading = true;

     const now = new Date();
     const mm = String(now.getMonth() + 1).padStart(2, '0');
     const dd = String(now.getDate()).padStart(2, '0');
     const mmdd = `${mm}-${dd}`;

     const minute = _this.toKoreanMinute(now);

     let url = _this.url;
     let data = { mmdd, minute, action: 'read' };

     let fnsuccess = function (result) {
      _this.loading = false;

      if (!result || result.ok !== true) {
       console.warn(result?.message || 'reflow log not found');

       // âœ… ì‹¤íŒ¨í•´ë„ ë§ˆì§€ë§‰ ë°ì´í„°ë¡œ rolling ì°¨íŠ¸ëŠ” ê°±ì‹  ê°€ëŠ¥
       const rows = _this._lastRows || [];
       const current = _this._lastCurrent || {};
       _this.bindProfileChartRolling(rows, current);
       return;
      }

      const rows = Array.isArray(result.data) ? result.data : [];
      const current = result.current || null;

      if (!current) {
       console.warn('current row not found');

       // âœ… current ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ rolling ì°¨íŠ¸ ê°±ì‹ 
       const rows2 = _this._lastRows || rows || [];
       const cur2 = _this._lastCurrent || {};
       _this.bindProfileChartRolling(rows2, cur2);
       return;
      }

      // âœ… í•­ìƒ ìµœì‹  rows/current ì €ì¥ (ì°¨íŠ¸ ticker/rollingìš©)
      _this._lastRows = rows;
      _this._lastCurrent = current;

      // âœ… ë³€ê²½ ê°ì§€ ê¸°ì¤€
      const curKey = current["ë‚  ì§œ"] || JSON.stringify(current);
      const changed = !(_this.lastRowKey && _this.lastRowKey === curKey);

      if (changed) {
       _this.lastRowKey = curKey;

       // âœ… ë³€ê²½ ìˆì„ ë•Œë§Œ KPI/í—¤ë” ê°±ì‹ 
       _this.bindHeader(current);
       _this.bindKpi(current);
      }

      // âœ… ì°¨íŠ¸/ë¦¬ìŠ¤í¬ëŠ” "í•­ìƒ" ê°±ì‹  (rolling ë•Œë¬¸ì—)
      _this.bindRiskAndCharts(rows, current);

      _this.bindSecondRow(rows, current);
      _this.bindTimeline(rows, current);

      // console.log('Reflow updated:', rows.length);
      // console.table(rows.slice(-5));
     };

     let fnerror = function (err) {
      _this.loading = false;
      console.error('reflow api error', err);

      // âœ… ì—ëŸ¬ì—¬ë„ ë§ˆì§€ë§‰ ë°ì´í„°ë¡œ rolling ì°¨íŠ¸ ê°±ì‹ 
      const rows = _this._lastRows || [];
      const current = _this._lastCurrent || {};
      _this.bindProfileChartRolling(rows, current);
     };

     AjaxUtil.getAsyncData(url, data, fnsuccess, fnerror);
    }

    toKoreanMinute(d) {
     const pad2 = (n) => String(n).padStart(2, '0');
     let h = d.getHours();
     const ampm = (h < 12) ? 'ì˜¤ì „' : 'ì˜¤í›„';
     let hh = h % 12;
     if (hh === 0) hh = 12;
     return `${ampm} ${pad2(hh)}:${pad2(d.getMinutes())}`;
    }

    bindHeader(current) {
     if (!current) return;

     const userLevel = current["ì‚¬ìš©ì ë ˆë²¨"] || "";
     const userId = current["ì‚¬ìš©ì ID"] || "";
     const jobPath = current["íŒŒì¼ ì´ë¦„"] || "";
     const mode = current["ê°€ë™ ìƒíƒœ"] || "";

     $('#hdr-user').text(`${userLevel}(${userId})`);
     $('#hdr-job').text(jobPath.split(/[/\\]/).pop());
     $('#hdr-mode').text(mode);

     const $run = $('#hdr-run');
     if (String(mode).includes('ì •ì§€')) {
      $run.removeClass('greenText').addClass('redText').html('<span>STOP</span>');
     } else {
      $run.removeClass('redText').addClass('greenText').html('<span>RUNNING</span>');
     }
    }

    bindKpi(current) {
     if (!current) return;

     // =========================
     // 1) ì„¤ë¹„ìƒíƒœ ì¹´ë“œ
     // =========================
     this.setText('#kpi-state', current["ê°€ë™ ìƒíƒœ"]); // STOP/ìë™/ìˆ˜ë™ ë“±

     // (ì§€ê¸ˆ HTMLì—ëŠ” job/user í‘œì‹œ ì˜ì—­ì´ ì—†ìŒ)
     // í•„ìš”í•˜ë©´ ì„¤ë¹„ìƒíƒœ ì¹´ë“œì— idë¥¼ ì¶”ê°€í•œ ë’¤ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”.
     // const jobPath = current["íŒŒì¼ ì´ë¦„"];
     // const jobName = jobPath ? String(jobPath).split(/[/\\]/).pop() : null;
     // this.setText('#kpi-job', jobName ?? jobPath);
     //
     // const level = (current["ì‚¬ìš©ì ë ˆë²¨"] ?? '').toString().trim();
     // const userId = (current["ì‚¬ìš©ì ID"] ?? '').toString().trim();
     // this.setText('#kpi-user', (level || userId) ? `${level}${userId ? ` (${userId})` : ''}` : 'ë¡œê·¸ì•„ì›ƒ');

     // =========================
     // 2) ìƒì‚° KPI ì¹´ë“œ
     // =========================
     const inQtyRaw  = current["íˆ¬ì… ìˆ˜ëŸ‰"];
     const outQtyRaw = current["ìƒì‚° ìˆ˜ëŸ‰"];
     const inQty  = this.toNum(inQtyRaw);
     const outQty = this.toNum(outQtyRaw);

     // íˆ¬ì…/ìƒì‚°
     this.setText(
      '#kpi-inout',
      (inQtyRaw != null && outQtyRaw != null) ? `${inQtyRaw} / ${outQtyRaw}` : '-'
     );

     // ê¸°íŒ ì •ì§€
     this.setText('#kpi-stop', current["ê¸°íŒ ì •ì§€"]);

     // Yield = ìƒì‚°/íˆ¬ì… * 100
     if (inQty != null && inQty > 0 && outQty != null) {
      this.setText('#kpi-yield', `${this.fmt((outQty / inQty) * 100, 1)}%`);
     } else {
      this.setText('#kpi-yield', '-');
     }

     // PPH (ì´ì „ ìŠ¤ëƒ…ìƒ·ê³¼ ì‹œê°„ì°¨ë¡œ ê³„ì‚°)
     let pph = null;
     const nowT = this.parseKpiTime(current["ë‚  ì§œ"]);
     if (this.prevKpiSnapshot && nowT && outQty != null) {
      const prevT = this.parseKpiTime(this.prevKpiSnapshot["ë‚  ì§œ"]);
      const prevOut = this.toNum(this.prevKpiSnapshot["ìƒì‚° ìˆ˜ëŸ‰"]);
      if (prevT && prevOut != null) {
       const dtSec = (nowT - prevT) / 1000;
       if (dtSec > 0) {
        const delta = outQty - prevOut;
        if (delta >= 0) pph = (delta / dtSec) * 3600;
       }
      }
     }
     this.setText('#kpi-pph', pph == null ? '-' : this.fmt(pph, 1));

     // =========================
     // 3) HZ ì¹´ë“œ (í˜„ì¬ê°’)
     // =========================
     this.setText('#kpi-heat16',  current["Heat 1-6"]);
     this.setText('#kpi-heat710', current["Heat 7-10"]);
     this.setText('#kpi-coolhz',  current["Cool"]);

     // =========================
     // 4) CM ì¹´ë“œ (ì»¨ë² ì´ì–´)
     // =========================
     this.setText('#kpi-cvspeed', current["C/V Speed"]);
     this.setText('#kpi-cvwidth', current["C/V WIDTH"]);

     // =========================
     // 5) PPM ì¹´ë“œ (N2 í˜„ì¬ê°’)
     //  - ë„¤ ë°ì´í„° êµ¬ì¡°: ë‹¨ ìœ„ + ì—ì–´(ì‚°ì†Œë†ë„) + ì§ˆì†Œ/ì—ì–´(ëª¨ë“œ)
     // =========================
     const unit = (current["ë‹¨ ìœ„"] ?? '').toString().trim();      // ì˜ˆ: PPM
     const val  = (current["ì—ì–´"] ?? '').toString().trim();       // ì˜ˆ: 10500 (ì‚°ì†Œë†ë„)
     const mode = (current["ì§ˆì†Œ/ì—ì–´"] ?? '').toString().trim();   // ì˜ˆ: N2

     // pv: "10500 PPM"
     const pvText = (val && unit) ? `${val} ${unit}` : (val || unit || '-');
     this.setText('#kpi-n2-pv', pvText);

     // mode: "(N2)" ë˜ëŠ” "-"
     this.setText('#kpi-n2-mode', mode ? `(${mode})` : '-');

     // ì „ë ¥(kW)
     this.setText('#kpi-kw', current["ìˆœì‹œ ì „ë ¥(kW)"]);

     // =========================
     // ë§ˆì§€ë§‰: prev ì €ì¥ (PPH ê³„ì‚°ìš©)
     // =========================
     this.prevKpiSnapshot = current;
    }

    toNum(v) {
     if (v == null) return null;
     const s = String(v).replace(/,/g, '').trim();
     const m = s.match(/-?\d+(\.\d+)?/);
     return m ? Number(m[0]) : null;
    }

    fmt(n, digits = 1) {
     if (n == null || Number.isNaN(n)) return '-';
     return Number(n).toFixed(digits);
    }

    setText(sel, v) {
     $(sel).text((v == null || v === '') ? '-' : v);
    }

    parseKpiTime(v) {
     if (!v) return null;
     const s = String(v).trim();
     const m = s.match(/^(\d{4})-(\d{2})-(\d{2})\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):(\d{2}):(\d{2})$/);
     if (m) {
      let [_, y, mo, d, ap, hh, mm, ss] = m;
      hh = Number(hh);
      if (ap === 'ì˜¤í›„' && hh < 12) hh += 12;
      if (ap === 'ì˜¤ì „' && hh === 12) hh = 0;
      return new Date(Number(y), Number(mo) - 1, Number(d), hh, Number(mm), Number(ss));
     }
     const dt = new Date(s);
     return isNaN(dt.getTime()) ? null : dt;
    }

    extractZones(row) {
     const zones = [];
     for (let z = 1; z <= 10; z++) {
      const ztSet = this.toNum(row[`ZT ì„¤ì •ê°’${z}`]);
      const ztCur = this.toNum(row[`ZT í˜„ì¬ê°’${z}`]);
      const zbSet = this.toNum(row[`ZB ì„¤ì •ê°’${z}`]);
      const zbCur = this.toNum(row[`ZB í˜„ì¬ê°’${z}`]);

      if (ztSet == null && ztCur == null && zbSet == null && zbCur == null) continue;

      const dtTopAbs = (ztSet != null && ztCur != null) ? Math.abs(ztCur - ztSet) : null;
      const dtBotAbs = (zbSet != null && zbCur != null) ? Math.abs(zbCur - zbSet) : null;

      const dtMax = (dtTopAbs == null && dtBotAbs == null)
       ? null
       : Math.max(dtTopAbs ?? 0, dtBotAbs ?? 0);

      const ztZb = (ztCur != null && zbCur != null) ? (ztCur - zbCur) : null;

      zones.push({
       zone: z,
       ztSet, ztCur, zbSet, zbCur,
       dtMax,
       ztZb,
       avgCur: (ztCur != null && zbCur != null) ? (ztCur + zbCur) / 2 : (ztCur ?? zbCur ?? null)
      });
     }
     return zones;
    }

    riskLabel(dtMax) {
     if (dtMax == null) return { text: '-', cls: 'risk-ok' };
     if (dtMax >= 6) return { text: 'ìœ„í—˜', cls: 'risk-crit' };
     if (dtMax >= 3) return { text: 'ì£¼ì˜', cls: 'risk-warn' };
     return { text: 'ì •ìƒ', cls: 'risk-ok' };
    }

    bindRiskAndCharts(rows, current) {
     if (!current) return;

     const zones = this.extractZones(current);

     // 1) ë¦¬ìŠ¤í¬ í…Œì´ë¸”(ìƒìœ„ 3ê°œ)
     const riskRows = zones
     .filter(z => z.dtMax != null)
     .sort((a, b) => (b.dtMax ?? -1) - (a.dtMax ?? -1))
     .slice(0, 3);

     const $tb = $('#riskTableBody');
     $tb.empty();

     if (riskRows.length === 0) {
      $tb.append(`<tr><td colspan="4" style="text-align:center; color:#888; padding:10px;">ë°ì´í„° ì—†ìŒ</td></tr>`);
     } else {
      for (const r of riskRows) {
       const lab = this.riskLabel(r.dtMax);
       const dtMaxTxt = `${r.dtMax.toFixed(1)}â„ƒ`;
       const ztZbTxt = (r.ztZb == null) ? '-' : `${r.ztZb.toFixed(1)}â„ƒ`;
       $tb.append(`
        <tr>
          <td>${r.zone}</td>
          <td>${dtMaxTxt}</td>
          <td>${ztZbTxt}</td>
          <td><span class="risk-badge ${lab.cls}">${lab.text}</span></td>
        </tr>
      `);
      }
     }

     // 2) Zone Î”T ë°” ì°¨íŠ¸
     const labels = zones.map(z => `Z${z.zone}`);
     const dataDt = zones.map(z => (z.dtMax == null ? 0 : Number(z.dtMax.toFixed(2))));

     const ctx1 = document.getElementById('zoneDtBarChart');
     if (ctx1 && window.Chart) {
      if (this._chartZoneDt) this._chartZoneDt.destroy();

      this._chartZoneDt = new Chart(ctx1, {
       type: 'bar',
       data: {
        labels: labels.length ? labels : ['-'],
        datasets: [{
         label: 'Î”T Max',
         data: dataDt.length ? dataDt : [0]
        }]
       },
       options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {legend: {display: false}},
        scales: {y: {beginAtZero: true}}
       }
      });
     }


     // 3) Profile ìš”ì•½(ìµœê·¼ 30ë¶„)  âœ… í˜„ì¬ì‹œê°„(now) ê¸°ì¤€ Rolling
     const now = new Date();                 // âœ… ë¬´ì¡°ê±´ í˜„ì¬ì‹œê°„
     const stepMs = 60 * 1000;               // 1ë¶„ ë²„í‚·
     const windowMs = 30 * 60 * 1000;        // 30ë¶„
     const startMs = now.getTime() - windowMs;

// 1) ìµœê·¼ 30ë¶„ íƒ€ì„ë²„í‚· ìƒì„± (ë¼ë²¨ ë = now)
     const buckets = [];
     for (let ms = startMs; ms <= now.getTime(); ms += stepMs) {
      buckets.push({ t: new Date(ms), value: null });
     }

// 2) rowsë¥¼ ë²„í‚·ì— ë§¤í•‘
     for (const row of rows) {
      const t = this.parseKpiTime(row["ë‚  ì§œ"]);
      if (!t) continue;

      const ms = t.getTime();
      if (ms < startMs || ms > now.getTime()) continue;

      const zs = this.extractZones(row);
      if (!zs.length) continue;

      const avgArr = zs.map(z => z.avgCur).filter(v => v != null);
      if (!avgArr.length) continue;

      const avgTemp = avgArr.reduce((a, b) => a + b, 0) / avgArr.length;

      // ê°€ì¥ ê°€ê¹Œìš´ ë¶„ ë²„í‚· ì¸ë±ìŠ¤
      const idx = Math.round((ms - startMs) / stepMs);
      if (buckets[idx]) buckets[idx].value = Number(avgTemp.toFixed(2));
     }

// 3) labels/data ìƒì„±
     const lbl2 = buckets.map(b => {
      const hh = String(b.t.getHours()).padStart(2, '0');
      const mm = String(b.t.getMinutes()).padStart(2, '0');
      return `${hh}:${mm}`;
     });
     const data2 = buckets.map(b => b.value);

// 4) profileText (ìœ íš¨ê°’ë§Œìœ¼ë¡œ í‰ê· /ìµœì†Œ/ìµœëŒ€)
     const validVals = data2.filter(v => v != null);
     if (validVals.length) {
      const mean = validVals.reduce((a, b) => a + b, 0) / validVals.length;
      const minv = Math.min(...validVals);
      const maxv = Math.max(...validVals);
      $('#profileText').text(
       `ìµœê·¼30ë¶„ í‰ê·  ${mean.toFixed(1)}â„ƒ (min ${minv.toFixed(1)} / max ${maxv.toFixed(1)})`
      );
     } else {
      $('#profileText').text('ìµœê·¼30ë¶„ ë°ì´í„° ì—†ìŒ');
     }

// 5) ë¼ì¸ ì°¨íŠ¸
     const ctx2 = document.getElementById('profileLineChart');
     if (ctx2 && window.Chart) {
      if (this._chartProfile) this._chartProfile.destroy();

      this._chartProfile = new Chart(ctx2, {
       type: 'line',
       data: {
        labels: lbl2.length ? lbl2 : ['-'],
        datasets: [{
         label: 'Zone í‰ê· ì˜¨ë„(ì‹¤ì¸¡)',
         data: data2.length ? data2 : [null], // âœ… null í—ˆìš©
         spanGaps: false,                     // âœ… null êµ¬ê°„ ì„  ëŠê¹€
         pointRadius: 0,
         tension: 0.25
        }]
       },
       options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
       }
      });
     }

    }

    // =========================
    // (4) 2ë²ˆì§¸ ì¤„ ë°”ì¸ë”©
    // =========================
    bindSecondRow(rows, current) {
     const rws = Array.isArray(rows) ? rows : [];
     if (!rws.length) {
      this.renderZoneTable([]);
      this.renderFlowSummary(null);
      this.renderStopSummary(null);
      this.renderProdTrendChart([], []);
      return;
     }

     const nowTs = Date.now();                 // âœ… ë¸Œë¼ìš°ì € í˜„ì¬ì‹œê°„
     const now = new Date(nowTs);
     now.setSeconds(0, 0);

     const start = new Date(now.getTime() - 30 * 60 * 1000);

     // âœ… 1) ì‹œê°„ íŒŒì‹± + âœ… 2) ë¯¸ë˜ row ì œê±° + âœ… 3) 30ë¶„ ìœˆë„ìš°ë§Œ
     const winRows = rws
     .map(row => ({ row, t: this.parseKpiTime(row["ë‚  ì§œ"]) }))
     .filter(x => x.t)
     .filter(x => new Date(x.t).getTime() <= nowTs) // âœ… ë¯¸ë˜ ì œê±°
     .sort((a,b) => new Date(a.t).getTime() - new Date(b.t).getTime())
     .filter(x => {
      const ms = new Date(x.t).getTime();
      return ms >= start.getTime() && ms <= nowTs;
     })
     .map(x => x.row);

     // âœ… ìœˆë„ìš° ì•ˆì— ì—†ìœ¼ë©´ "í‘œì‹œí•  ë°ì´í„° ì—†ìŒ" ì²˜ë¦¬
     if (!winRows.length) {
      this.renderZoneTable([]);
      this.renderFlowSummary(null);
      this.renderStopSummary(null);
      this.renderProdTrendChart([], []);
      $('#stopCountText').text('ìµœê·¼30ë¶„ ë°ì´í„° ì—†ìŒ');
      return;
     }

     // 1) Zone í…Œì´ë¸”
     const zoneItems = this.calcZoneSetAvgDelta(winRows);
     this.renderZoneTable(zoneItems);

     // 2) íˆ¬ì…/ìƒì‚°: ìµœì‹  row(ìœˆë„ìš° ë‚´ ë§ˆì§€ë§‰)
     const latestRow = winRows[winRows.length - 1];
     this.renderFlowSummary(latestRow);

     // 3) ì •ì§€: ìµœê·¼30ë¶„ ì¦ê°€ë¶„
     const stopCnt = this.calcStopEvents(winRows);
     this.renderStopSummary(stopCnt);

     // 4) ìƒì‚°ëŸ‰ ê·¸ë˜í”„
     const { labels, series } = this.calcProdDeltaSeries(winRows, start, now);
     this.renderProdTrendChart(labels, series);
    }

// --- Zone í…Œì´ë¸” ê³„ì‚°: ZT ì„¤ì •ê°’ vs ZT í˜„ì¬ê°’ í‰ê· 
    calcZoneSetAvgDelta(winRows) {
     const stats = {}; // Z1..Z10
     const add = (zone, setv, curv) => {
      if (curv == null) return;
      if (!stats[zone]) stats[zone] = { zone, set: setv, sum: 0, cnt: 0 };
      if (stats[zone].set == null && setv != null) stats[zone].set = setv;
      stats[zone].sum += curv;
      stats[zone].cnt += 1;
     };

     for (const row of winRows) {
      for (let i = 1; i <= 10; i++) {
       add(
        `Z${i}`,
        this.toNum(row[`ZT ì„¤ì •ê°’${i}`]),
        this.toNum(row[`ZT í˜„ì¬ê°’${i}`])
       );
      }
     }

     return Object.values(stats)
     .sort((a,b) => parseInt(a.zone.slice(1),10) - parseInt(b.zone.slice(1),10))
     .map(s => {
      const avg = s.cnt ? (s.sum / s.cnt) : null;
      const setv = s.set;
      const delta = (avg != null && setv != null) ? (avg - setv) : null;
      const absd = delta == null ? 0 : Math.abs(delta);
      const level = absd >= 5 ? 'risk' : absd >= 3 ? 'warn' : 'ok';
      return { zone: s.zone, set: setv, avg, delta, level };
     });
    }

// --- Zone í…Œì´ë¸” ë Œë”
    renderZoneTable(items) {
     const $tb = $('#zoneTableBody');
     $tb.empty();

     if (!items || !items.length) {
      $tb.append(`<tr><td colspan="4" style="text-align:center; color:#888; padding:10px;">ìµœê·¼30ë¶„ ë°ì´í„° ì—†ìŒ</td></tr>`);
      return;
     }

     for (const it of items) {
      const setTxt = it.set == null ? '-' : it.set.toFixed(0);
      const avgTxt = it.avg == null ? '-' : it.avg.toFixed(1);
      const dTxt   = it.delta == null ? '-' : (it.delta >= 0 ? `+${it.delta.toFixed(1)}` : `${it.delta.toFixed(1)}`);

      const color = it.level === 'risk' ? '#d9534f' : it.level === 'warn' ? '#f0ad4e' : '#2e7d32';
      const icon  = it.level === 'risk' ? ' âš ' : '';

      $tb.append(`
      <tr>
        <td style="text-align:center;">${it.zone}</td>
        <td style="text-align:right;">${setTxt}</td>
        <td style="text-align:right;">${avgTxt}</td>
        <td style="text-align:right; font-weight:700; color:${it.delta == null ? '#888' : color};">${dTxt}${icon}</td>
      </tr>
    `);
     }
    }

// --- íˆ¬ì…/ìƒì‚° í‘œì‹œ
    renderFlowSummary(latestRow) {
     if (!latestRow) {
      $('#flow-in').text('-');
      $('#flow-out').text('-');
      return;
     }
     const inCnt  = this.toNum(latestRow["íˆ¬ì… ìˆ˜ëŸ‰"]);
     const outCnt = this.toNum(latestRow["ìƒì‚° ìˆ˜ëŸ‰"]);

     $('#flow-in').text(inCnt == null ? '-' : inCnt.toLocaleString());
     $('#flow-out').text(outCnt == null ? '-' : outCnt.toLocaleString());
    }

// --- ì •ì§€ ë°œìƒ(ìµœê·¼30ë¶„): ê¸°íŒ ì •ì§€ ëˆ„ì  ì¦ê°€ë¶„ í•©
    calcStopEvents(winRows) {
     if (!winRows || winRows.length < 2) return 0;
     let prev = null;
     let cnt = 0;

     for (const r of winRows) {
      const cur = this.toNum(r["ê¸°íŒ ì •ì§€"]);
      if (cur == null) continue;

      if (prev != null) {
       const diff = cur - prev;
       if (diff > 0) cnt += diff;
      }
      prev = cur;
     }
     return cnt;
    }

    renderStopSummary(stopCnt) {
     if (stopCnt == null) {
      $('#stopCountText').text('ìµœê·¼30ë¶„ ì •ì§€ ë°ì´í„° ì—†ìŒ');
     } else {
      $('#stopCountText').text(`ì •ì§€ ë°œìƒ: ${stopCnt}íšŒ`);
     }
    }

// --- ìµœê·¼30ë¶„ ìƒì‚°ëŸ‰(ë¶„ë‹¹ ìƒì‚° ì¦ê°€ëŸ‰) ì‹œë¦¬ì¦ˆ ê³„ì‚°
    calcProdDeltaSeries(winRows, start, now) {
     const stepMs = 60 * 1000;
     const bucketCount = Math.floor((now.getTime() - start.getTime()) / stepMs) + 1;

     const buckets = Array.from({ length: bucketCount }, (_, i) => ({
      t: new Date(start.getTime() + i * stepMs),
      v: null
     }));

     // ì‹œê°„ìˆœ
     const sorted = [...(winRows || [])].sort((a,b) => {
      const ta = this.parseKpiTime(a["ë‚  ì§œ"]);
      const tb = this.parseKpiTime(b["ë‚  ì§œ"]);
      return new Date(ta).getTime() - new Date(tb).getTime();
     });

     let prevOut = null;
     for (const r of sorted) {
      const t0 = this.parseKpiTime(r["ë‚  ì§œ"]);
      if (!t0) continue;

      const t = new Date(t0);
      t.setSeconds(0,0);

      const idx = Math.floor((t.getTime() - start.getTime()) / stepMs);
      if (idx < 0 || idx >= buckets.length) continue;

      const outCum = this.toNum(r["ìƒì‚° ìˆ˜ëŸ‰"]);
      if (outCum == null) continue;

      let delta = null;
      if (prevOut != null) delta = Math.max(0, outCum - prevOut);
      prevOut = outCum;

      buckets[idx].v = delta;
     }

     const labels = buckets.map(b => {
      const hh = String(b.t.getHours()).padStart(2,'0');
      const mm = String(b.t.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
     });

     const series = buckets.map(b => b.v);
     return { labels, series };
    }

// --- ìƒì‚°ëŸ‰ ê·¸ë˜í”„ ë Œë” (Chart.js)
    renderProdTrendChart(labels, series) {
     const ctx = document.getElementById('prodTrendChart');
     if (!ctx || !window.Chart) return;

     if (!this._chartProdTrend) {
      this._chartProdTrend = new Chart(ctx, {
       type: 'line',
       data: {
        labels: labels || [],
        datasets: [{
         label: 'ë¶„ë‹¹ ìƒì‚°ëŸ‰',
         data: series || [],
         spanGaps: false,
         pointRadius: 0,
         tension: 0.25
        }]
       },
       options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
       }
      });
     } else {
      this._chartProdTrend.data.labels = labels || [];
      this._chartProdTrend.data.datasets[0].data = series || [];
      this._chartProdTrend.update('none');
     }
    }

    // =========================
    // (5) ì•ŒëŒ/ì´ìƒì¡°ì§ íƒ€ì„ë¼ì¸
    // =========================
    bindTimeline(rows, current) {
     const rws = Array.isArray(rows) ? rows : [];
     const $wrap = $('#eventTimeline');
     $wrap.empty();

     if (!rws.length) {
      $wrap.html(`<div style="color:#888; padding:8px 0;">ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`);
      return;
     }

     // âœ… ë¸Œë¼ìš°ì € ì‹œê°„ ê¸°ì¤€ (ë¯¸ë˜ ì œê±°ìš©)
     // 1ë¶„ ì •ë„ ì˜¤ì°¨ê°€ ë‚œë‹¤ê³  í–ˆìœ¼ë‹ˆ, ì•½ê°„ì˜ í—ˆìš©ì¹˜(ì˜ˆ: 90ì´ˆ) ì£¼ë©´ "1ë¶„ ë¯¸ë˜"ê°€ ì•ˆ ë³´ì´ê²Œ ì•ˆì •ì 
     const nowTs = Date.now();
     const skewMs = 90 * 1000; // í•„ìš” ì—†ìœ¼ë©´ 0ìœ¼ë¡œ

     const sorted = rws
     .map(r => ({ r, t: this.parseKpiTime(r["ë‚  ì§œ"]) }))
     .filter(x => x.t)
     // âœ… ë¯¸ë˜ row ì œê±° (í—ˆìš©ì¹˜ ì ìš©)
     .filter(x => new Date(x.t).getTime() <= nowTs + skewMs)
     .sort((a, b) => new Date(a.t).getTime() - new Date(b.t).getTime())
     .map(x => x.r);

     if (!sorted.length) {
      $wrap.html(`<div style="color:#888; padding:8px 0;">(í˜„ì¬ ê¸°ì¤€) í‘œì‹œí•  ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`);
      return;
     }

     // âœ… ì „ì²´ ì´ë ¥ìœ¼ë¡œ ì´ë²¤íŠ¸ ìƒì„±
     const events = this.buildEvents(sorted);
     if (!events.length) {
      $wrap.html(`<div style="color:#888; padding:8px 0;">ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`);
      return;
     }

     // ìµœì‹ ì´ ìœ„
     events.sort((a, b) => b.ts - a.ts);

     const html = events.map(ev => {
      const tagCls = ev.level === 'DANGER' ? 'danger' : ev.level === 'WARN' ? 'warn' : 'info';

      // âœ… ì˜¤ì „/ì˜¤í›„ + HH:mm ë§Œë“¤ê¸°
      const d = new Date(ev.ts);
      const hh = d.getHours();                 // 0~23
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ap = hh < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
      const hh12 = String((hh % 12) === 0 ? 12 : (hh % 12)).padStart(2,'0'); // 12ì‹œê°„ì œ
      const timeText = `${ap} ${hh12}:${mm}`;  // ì˜ˆ: "ì˜¤ì „ 08:55", "ì˜¤í›„ 01:05"

      // ë ˆë²¨ë³„ ìƒ‰ìƒ
      const bg  = ev.level === 'DANGER' ? '#ffecec' : ev.level === 'WARN' ? '#fff8e6' : '#f5f7ff';
      const bd  = ev.level === 'DANGER' ? '#ffb5b5' : ev.level === 'WARN' ? '#ffe3a3' : '#dfe6ff';
      const badgeBg = ev.level === 'DANGER' ? '#ff4d4f' : ev.level === 'WARN' ? '#ffbf3a' : '#5b7cff';
      const badgeColor = ev.level === 'WARN' ? '#111' : '#fff';

      return `
    <div class="timeline-row ${tagCls}" data-ts="${ev.ts}"
         style="
           display:grid;
           grid-template-columns: 88px 52px 1fr; /* âœ… ì‹œê°„ì¹¸ ì¡°ê¸ˆ ë„“í˜ */
           align-items:center;
           gap:10px;
           padding:8px 10px;
           border-radius:10px;
           border:1px solid ${bd};
           background:${bg};
           cursor:pointer;
           user-select:none;
         ">
      <div class="tl-time" style="color:#666; font-weight:700; font-variant-numeric:tabular-nums;">
        ${timeText}
      </div>
      <div class="tl-badge" style="
           font-size:12px;
           font-weight:900;
           text-align:center;
           padding:4px 0;
           border-radius:999px;
           background:${badgeBg};
           color:${badgeColor};
         ">
        ${ev.levelKorean}
      </div>
      <div class="tl-text" style="
           font-weight:700;
           color:#222;
           overflow:hidden;
           text-overflow:ellipsis;
           white-space:nowrap;
           min-width:0;
         ">
        ${ev.text}
      </div>
    </div>
  `;
     }).join('');

     $wrap.html(html);

     $wrap.off('click.timeline').on('click.timeline', '.timeline-row', (e) => {
      const ts = Number($(e.currentTarget).data('ts'));
      if (!ts) return;
      this.syncToTime(rows, ts);
     });
    }

    buildEvents(rowsInWindow) {
     const events = [];

     const zoneWarnOn = {};
     const zoneDangerOn = {};
     let prevModeStop = null;

     const outDeltas = [];
     let prevOutCum = null;

     for (const row of rowsInWindow) {
      const t = this.parseKpiTime(row["ë‚  ì§œ"]);
      if (!t) continue;

      const ts = new Date(t).getTime();
      if (ts > Date.now()) continue;
      const timeText = this.hhmm(ts);

      // 1) ìë™ì •ì§€ ë°œìƒ
      const mode = String(row["ê°€ë™ ìƒíƒœ"] ?? '');
      const isStop = mode.includes('ì •ì§€');
      if (prevModeStop !== null && prevModeStop === false && isStop === true) {
       events.push({ ts, timeText, level:'DANGER', levelKorean:'ìœ„í—˜', text:'ìë™ì •ì§€ ë°œìƒ' });
      }
      prevModeStop = isStop;

      // 2) Zone Î”T ì´ˆê³¼ (WARN/DANGER ì¤‘ í•˜ë‚˜ë§Œ ë°œìƒ)
      const zones = this.extractZones(row) || [];
      for (const z of zones) {
       if (z.dtMax == null) continue;

       const dt = Number(z.dtMax);
       const zoneKey = String(z.zone);

       // âœ… í˜„ì¬ ë ˆë²¨ì„ í•˜ë‚˜ë¡œ ê²°ì • (dangerê°€ warnì„ ë®ì–´ì”€)
       const level =
        dt >= 6 ? 'DANGER' :
         dt >= 5 ? 'WARN'   :
          null;

       // âœ… ì¡´ë³„ í˜„ì¬ ON ìƒíƒœ(ë ˆë²¨) ì¶”ì : null/WARN/DANGER
       zoneWarnOn[zoneKey]   ??= false;
       zoneDangerOn[zoneKey] ??= false;

       // OFF ì²˜ë¦¬
       if (level === null) {
        zoneWarnOn[zoneKey] = false;
        zoneDangerOn[zoneKey] = false;
        continue;
       }

       // âœ… dangerë©´ warn ì´ë²¤íŠ¸ëŠ” ë§Œë“¤ì§€ ì•Šê³  dangerë§Œ ê´€ë¦¬
       if (level === 'DANGER') {
        if (!zoneDangerOn[zoneKey]) {
         zoneDangerOn[zoneKey] = true;
         zoneWarnOn[zoneKey] = true; // dangerë©´ warnë„ â€œì¼œì§„ ìƒíƒœâ€ë¡œ ì·¨ê¸‰(ì¤‘ë³µ ë°©ì§€)
         events.push({
          ts, timeText,
          level: 'DANGER', levelKorean: 'ìœ„í—˜',
          text: `Z${z.zone} Î”T ${dt.toFixed(1)}â„ƒ ì´ˆê³¼`
         });
        }
        continue;
       }

       // level === 'WARN'
       if (!zoneWarnOn[zoneKey]) {
        zoneWarnOn[zoneKey] = true;
        events.push({
         ts, timeText,
         level: 'WARN', levelKorean: 'ì£¼ì˜',
         text: `Z${z.zone} Î”T ${dt.toFixed(1)}â„ƒ ì´ˆê³¼`
        });
       }
      }

      // 3) ìƒì‚°ëŸ‰ ê¸‰ê°
      const outCum = this.toNum(row["ìƒì‚° ìˆ˜ëŸ‰"]);
      if (outCum != null) {
       let delta = null;
       if (prevOutCum != null) delta = Math.max(0, outCum - prevOutCum);
       prevOutCum = outCum;

       if (delta != null) {
        outDeltas.push({ ts, delta });

        const fiveMinAgo = ts - 5 * 60 * 1000;
        const recent = outDeltas.filter(x => x.ts >= fiveMinAgo);
        const avg = recent.length ? recent.reduce((a,b) => a + b.delta, 0) / recent.length : null;

        if (avg != null && avg >= 1 && delta <= avg * 0.3) {
         const dup = events.find(ev => ev.text === 'ìƒì‚°ëŸ‰ ê¸‰ê°' && Math.abs(ev.ts - ts) <= 3 * 60 * 1000);
         if (!dup) {
          events.push({ ts, timeText, level:'WARN', levelKorean:'ì£¼ì˜', text:'ìƒì‚°ëŸ‰ ê¸‰ê°' });
         }
        }
       }
      }
     }

     return events;
    }

    syncToTime(rows, ts) {
     const rws = Array.isArray(rows) ? rows : [];
     if (!rws.length) return;

     let best = null;
     let bestDiff = Infinity;

     for (const r of rws) {
      const t = this.parseKpiTime(r["ë‚  ì§œ"]);
      if (!t) continue;
      const ms = new Date(t).getTime();
      const diff = Math.abs(ms - ts);
      if (diff < bestDiff) {
       bestDiff = diff;
       best = r;
      }
     }

     if (!best) return;

     this.bindRiskAndCharts(rows, best);
     this.bindSecondRow(rows, best);
    }

    hhmm(ts) {
     const d = new Date(ts);
     const hh = String(d.getHours()).padStart(2,'0');
     const mm = String(d.getMinutes()).padStart(2,'0');
     return `${hh}:${mm}`;
    }

   }//DashPage

   let page = null;

   $(document).ready(function (e) {
    page = new DashPage();
    page.init();

   });
  </script>
</th:block>
<input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>
</html>