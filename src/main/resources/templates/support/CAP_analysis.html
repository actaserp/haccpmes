<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
  <style>
      .wj-header {
          text-align: center !important;
      }
  </style>
</head>

<th:block layout:fragment="content">

  <style>
      .input-with-button {
          display: flex;
          width: 100%;
          gap: 4px;
      }

      .input-clear {
          display: flex;
          flex: 1;
          position: relative;
          align-items: center;
      }

      .input-clear input {
          flex: 1;
          min-width: 0;
          padding-right: 24px; /* clear ë²„íŠ¼ ê³µê°„ í™•ë³´ */
      }

      .btn-clear {
          position: absolute;
          right: 6px;
          cursor: pointer;
      }

      .in_btn.cap {
          width: 35px;
          padding: 4px;
          min-width: 0;
          align-items: center;
          justify-content: left;
      }
  </style>
  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>CAP ë¶„ì„</h2>
        <a title="ë¶ë§ˆí¬" class="bookmark toggle">
          ë‚´ë©”ë‰´
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ë³´ê³ ì„œ</li>
        <li>CAP ë¶„ì„</li>
      </ul>
    </div>

    <div style="display: flex; gap: 5px">
      <section class="section" style="width: 60%;">
        <div class="section-top">
          <div class="search-wrap">
            <dl>
              <dt>
                <label>CAP ë²ˆí˜¸</label>
              </dt>
              <dd>
                <div class="srch-box">
                  <input type="text" id="txtMatgrp" name="txtMatgrp" class="form-control2" placeholder="CAP ë²ˆí˜¸"/>
                </div>
              </dd>
            </dl>

            <dl>
              <dt><span class="eq"></span></dt>
              <dd>
                <li>
                  <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                    ê²€ìƒ‰
                  </a>
                </li>
              </dd>
            </dl>


          </div>
        </div> <!--//section-top end -->
        <div class="container-fluid">
          <p id="selectedItem"></p>
          <div id="theGrid" style=""></div>
        </div>
        <div class="btn-wrap">
        </div>
      </section>
      <section style="width: 40%;">
        <div class="section-top">
          <div class="search-wrap">
            <ul>
              <li>
                <button type="button" class="btn-excellt btn-default" id="btnNew" name="btnNew"
                        style="height: 36px; width:115px;"><i
                    class="fas fa-plus"></i>ì‹ ê·œë“±ë¡
                </button>
              </li>

              <li>
                <button type="button" class="btn-excellt btn-default y_write_auth" id="btnSave"
                        style="float:none; height: 36px; width:115px;">
                  <i class="fas fa-save"></i>ì €ì¥
                </button>
              </li>
              <li>
                <button type="button" class="btn-delete btn-danger y_write_auth" id="btnDel"
                        style="float:none; height: 36px; width:115px;"><i
                    class="fas fa-trash"></i>ì‚­ì œ
                </button>
              </li>
            </ul>
          </div>
        </div>

        <div class="table-wrap" style=" overflow-x: auto;">
          <form id="CapAnalysisForm">
            <table class="write-table" id="detail_box">
              <caption style="text-align: left; margin-bottom: 8px;">CAP ë“±ë¡í…Œì´ë¸”</caption>
              <colgroup>
                <col class="wp20">
                <col class="wp80">
              </colgroup>
              <input type="hidden" id="id" name="id"/>
              <tbody>
              <tr>
                <th >
                  <label for="cap_number"><span class="eq">*</span>CAP ë²ˆí˜¸</label>
                </th>
                <td >
                  <input type="text" id="cap_number" name="cap_number" style="width: 100%;" placeholder="CAP ë²ˆí˜¸" readonly/>
                </td>
              </tr>
              <tr>
                <th >
                  <label for="date_occurrence"><span class="eq">*</span>ë°œìƒì¼</label>
                </th>
                <td >
                  <input type="date" id="date_occurrence" name="date_occurrence" style="width: 100%;" placeholder="ë°œìƒì¼"/>
                </td>
              </tr>
              <tr>
                <th >
                  <label for="date_finish"><span class="eq">*</span>ì™„ë£Œì¼</label>
                </th>
                <td >
                  <input type="date" id="date_finish" name="date_finish" style="width: 100%;" placeholder="ì™„ë£Œì¼"/>
                </td>
              </tr>
              <tr>
                <th >
                  <label for="cap_depart"><span class="eq">*</span>ë°œìƒ ë¶€ì„œ</label>
                </th>
                <td >
                <select class="" id="cap_depart" name="cap_depart" style="width: 100%;">
                                    </select>
                                    
                </td>
              </tr>
              <tr>
                <th >
                  <label for="product"><span class="eq">*</span>í’ˆëª©</label>
                </th>
                <td style="width: 100%;">
                  <div class="input-with-button">
                    <div class="input-clear">
                      <input type="text" id="product" readonly name="product" placeholder="í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”" />
                    </div>
                    <a class="btn in_btn cap" title="í’ˆëª© ê²€ìƒ‰" id="btnProductSearch">
                      <img src="/images/icon/btn-srch-black.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜" />
                    </a>
                  </div>

                  <!-- hidden input -->
                  <input type="hidden" id="product_code" name="product_code" />
                  <input type="hidden" id="material_id" name="material_id" />
                </td>
              </tr>

              <tr>
                <th >
                  <label for="company"><span class="eq">*</span>ê±°ë˜ì²˜</label>
                </th>
                <td style="width: 100%;">
                  <div class="input-with-button">
                    <div class="input-clear">
                      <input type="text" id="cboCompany" readonly name="cboCompany" placeholder="ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”" />
                    </div>
                    <a class="btn in_btn cap" title="ê±°ë˜ì²˜ ê²€ìƒ‰" id="btnCompanySearch">
                      <img src="/images/icon/btn-srch-black.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜" />
                    </a>
                  </div>

                  <!-- hidden input -->
                  <input type="hidden" id="cboCompanyText" name="cboCompanyText" />
                  <input type="hidden" id="cboCompanyHidden" name="cboCompanyHidden" />
                </td>
              </tr>  


              <tr>
                <th >
                  <label for="cap_unit"><span class="eq">*</span>ì¸¡ì •ë‹¨ìœ„</label>
                </th>
                <td >
                  <select class="" id="cap_unit" name="cap_unit"  style="width: 100%;">
                                    </select>
                </td>
              </tr>
              <tr>
                <th >
                  <label for="cap_progress"><span class="eq">*</span>ì§„í–‰ìƒíƒœ</label>
                </th>
                <td >
                  <select id="cap_progress" name="cap_progress" style="width: 100%">
                      <option value="ì ‘ìˆ˜">ì ‘ìˆ˜</option>
                      <option value="ì§„í–‰">ì§„í–‰</option>
                      <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                  </select>
                </td>
              </tr>
              <tr>
                <th >
                  <label for="cap_process"><span class="eq">*</span>ë°œìƒê³µì •</label>
                </th>
                <td >
                  <select class="" id="cap_process" name="cap_process"  style="width: 100%;">
                  </select>
                </td>
              </tr>
              <!-- <tr>
                <th >
                  <label for="cap_claims"><span class="eq">*</span>í´ë ˆì„ ìœ í˜•</label>
                </th>
                <td >
                  <input type="text" id="cap_claims" name="cap_claims" style="width: 100%;" placeholder="í´ë ˆì„ ìœ í˜•"/>
                </td>
              </tr> -->


              <tr>
                <th >
                  <label for="defect_type"><span class="eq">*</span>ë¶€ì í•© ìœ í˜•</label>
                </th>
                <td >
                  <select class="" id="defect_type" name="defect_type"  style="width: 100%;">
                  </select>
                </td>
              </tr>  
              

              <tr>
                <th >
                  <label for="cap_creater_id"><span class="eq">*</span>ì‘ì„±ì</label>
                </th>
                <td >
                  <input type="text" id="cap_creater_id" name="cap_creater_id" style="width: 100%;" placeholder="ì‘ì„±ì"/>
                </td>
              </tr>
              <tr>
                <th >
                  <label for="cap_problem_content"><span class="eq">*</span>ë¬¸ì œ ìš”ì•½</label>
                </th>
                <td >
                  <textarea type="text" id="cap_problem_content" name="cap_problem_content" style="width: 100%;" placeholder="ë¬¸ì œìš”ì•½"></textarea>
                </td>
              </tr>
              </tbody>
            </table>
          </form>
        </div>
        <!--//tab-wrap end-->
      </section>
    </div>
  </div> <!--//layout-contents end -->

  <footer style="margin-top: 24px;">
    <p>Copyrightâ“’ 0000 corp. All rights reserved.</p>
  </footer>

</th:block>
<th:block layout:fragment="scripts">
  <th:block th:replace="/common/approve_box :: approve_box"></th:block>
  <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
  <th:block th:replace="/common/popup_company :: popup_company"></th:block>

  <th:block th:replace="/common/multiform_material :: multiform_material"></th:block>

  <script type="text/javascript">
    class CAPAnalysisPage {
      constructor() {
         this.theGrid = null;
        this.viewData = new wijmo.collections.CollectionView([]);
        this.init();
      }

      init() {
        let _this = this;
        this.grid = new wijmo.grid.FlexGrid('#theGrid', {
          selectionMode: wijmo.grid.SelectionMode.Row,
          headersVisibility: wijmo.grid.HeadersVisibility.Column,
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,

          formatItem: (sender, e) => {
            if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
              e.cell.style.textAlign = 'center';
            }
          },

          columns: [
            {binding: 'id', header: 'id', width: 150, visible: false},
            {binding: 'cap_no', header: 'CAP ë²ˆí˜¸', width: 150, align: 'center'},
            {binding: 'occur_depart', header: 'ë°œìƒë¶€ì„œid', width: 70, align: 'center', visible: false},
            {binding: 'depart_name', header: 'ë°œìƒë¶€ì„œ', width: 120, align: 'center'},
            
            {binding: 'company_id', header: 'ê±°ë˜ì²˜id', width: 120, align: 'center', visible: false},
            {binding: 'company_name', header: 'ê±°ë˜ì²˜', width: 120, align: 'center'},
            

            {binding: 'material_name', header: 'í’ˆëª©', width: 120, align: 'center'},
            {binding: 'unit_name', header: 'ì¸¡ì •ë‹¨ìœ„', width: 120, align: 'center'},
            {binding: 'status', header: 'ì§„í–‰ìƒíƒœ', width: 120, align: 'center'},
            {binding: 'process_name', header: 'ë°œìƒê³µì •', width: 120, align: 'center'},

            {binding: 'defect_type_name', header: 'ë¶€ì í•©ìœ í˜•', width: 120, align: 'center'},
            {binding: 'defect_type_id', header: 'ë¶€ì í•©ìœ í˜•id', width: 120, align: 'center', visible: false},
            
            
            {binding: 'writer', header: 'ì‘ì„±ì', width: 120, align: 'center'},

          ],
          itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
        });

        new FlexGridContextMenu(this.grid);
        this.grid.downloadFileName = 'CAP ë¶„ì„';

        this.grid.hostElement.addEventListener('click', function (e) {
          let items = _this.grid.selectedItems[0];
        
          $('#cap_number').val(items.cap_no);
          //$('#cap_claims').val(items.claim_type);
          $('#cap_depart').val(items.occur_depart);
          $('#id').val(items.id);
          $('#cap_problem_content').val(items.issue_summary);
          $('#material_id').val(items.material_id);
          $('#product').val(items.material_name);
          $('#date_occurrence').val(items.occur_date);

          $('#date_finish').val(items.process_date);

          $('#cboCompanyHidden').val(items.company_id);
          $('#cboCompany').val(items.company_name);
          $('#defect_type').val(items.defect_type_id);
          
          $('#cap_process').val(items.process_id);
          $('#cap_progress').val(items.status);
          $('#cap_unit').val(items.unit_id);
          $('#cap_creater_id').val(items.writer);
        
        });

        $('#btnProductSearch').click(function () {
          const $productName = $('#product');
          const $productId = $('#material_id');
          const $productCode = $('#product_code');

          const pop = new PopMatComponent();
          pop.material_type = 'product,sangpum';

          pop.show(function (item) {
            $productName.val(item.Name);
            $productId.val(item.id);
            $productCode.val(item.Code);
          });
        });

        $('#btnCompanySearch').click(function () {

            let poppage = new PopCompComponent();
            let $poppage = $(poppage);
            let searchcallback = function (items) {
                // $content.find('#cboCompany').val(items.id);
                // $content.find('#CompanyName').val(items.compname);
                console.log('items : ',items);
                document.getElementById('cboCompany').value = items.compname;
                document.getElementById('cboCompanyHidden').value = items.id;
            };

            poppage.show(searchcallback);
        });

        $('#product').on('input', function () {
          if (!$(this).val().trim()) {
            $('#product_code').val('');
            $('#material_id').val('');
          }
        });

      }//init

      searchMainData(){

        let _this = this;

        $.ajax({
                url: '/api/support/cap/read',
                type: 'GET',
                data: {
                    'capNo': $('#txtMatgrp').val(),
                    spjangcd: sessionStorage.getItem('spjangcd'),
                },
                async: false,
                success: function (result) {
                    if (result.success) {
                        _this.viewData.sourceCollection = result.data;
                    } else {
                        Alert.alert('', 'ì—ëŸ¬ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.');
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching log_list data:', textStatus, errorThrown);

                }
            });
      }

      save(){

        let _this = this;
        
        let url = '/api/support/cap/save';
      
        // ğŸ” í•„ìˆ˜ê°’ ì²´í¬
        const dateOccurrence = $('#date_occurrence').val();
        const materialId = $('#material_id').val();
        const companyId = $('#cboCompanyHidden').val();
        const capProgress = $('#cap_progress').val();
        const capProcess = $('#cap_process').val();
        const defectType = $('#defect_type').val();

        if (!dateOccurrence) {
            Alert.alert('', 'ë°œìƒì¼ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            $('#date_occurrence').focus();
            return;
        }

        if (!materialId) {
            Alert.alert('', 'í’ˆëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            $('#product').focus();
            return;
        }

        if (!companyId) {
            Alert.alert('', 'íšŒì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!capProgress) {
            Alert.alert('', 'ì§„í–‰ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            $('#cap_progress').focus();
            return;
        }

        if (!capProcess) {
            Alert.alert('', 'ë°œìƒê³µì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            $('#cap_process').focus();
            return;
        }

        if (!defectType) {
            Alert.alert('', 'ë¶ˆëŸ‰ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            $('#defect_type').focus();
            return;
        }

        let data = FormUtil.extractForm($('#CapAnalysisForm'));
        data.spjangcd=sessionStorage.getItem('spjangcd');

        Alert.confirm('', 'ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                let fnSuccess = function (result) {
                    if (result.success) {
                        Alert.alert('', 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                        _this.searchMainData(); // ì €ì¥ í›„ ë°ì´í„° ê°±ì‹ 
                    } else {
                        Alert.alert('ì €ì¥ ì‹¤íŒ¨', result.message);
                        console.error('ì €ì¥ ì‹¤íŒ¨:', result.message);
                    }
                };

                // ë°ì´í„° ì €ì¥ ìš”ì²­
                AjaxUtil.postAsyncData(url, data, fnSuccess);
            });
      }

      delete(){

        let _this = this;
        
        let url = '/api/support/cap/delete';

        let items = _this.grid.selectedItems[0];
      
        let data = {
          'capNo' : items.cap_no
        }

        Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                let fnSuccess = function (result) {
                    if (result.success) {
                        Alert.alert('', 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                        _this.searchMainData(); // ì €ì¥ í›„ ë°ì´í„° ê°±ì‹ 
                    } else {
                        Alert.alert('ì €ì¥ ì‹¤íŒ¨', result.message);
                        console.error('ì €ì¥ ì‹¤íŒ¨:', result.message);
                    }
                };

                // ë°ì´í„° ì €ì¥ ìš”ì²­
                AjaxUtil.postAsyncData(url, data, fnSuccess);
            });
      }

    }//CAPAnalysisPage

    let page = null;
    var picker = new ax5.ui.picker();

    $(document.body).ready(function (e) {

      page = new CAPAnalysisPage();

      let today = new Date();
      $('#date_occurrence').val(CommonUtil.formatYYYYMMDD(today));

      //page.searchMainData();

      AjaxUtil.fillSelectOptions($('#cap_depart'), 'depart', 'all', '', null);
      AjaxUtil.fillSelectOptions($('#cap_unit'), 'unit', 'all', '', null);
      AjaxUtil.fillSelectOptions($('#cap_process'), 'process', 'all', '', null);
      AjaxUtil.fillSelectOptions($('#defect_type'), 'defect_type', '', '', null);
      
            

      // ê²€ìƒ‰ë²„íŠ¼
      $('#btnSearch').click(function (e) {
        page.searchMainData();
      });

      // ì—”í„°í‚¤ ê²€ìƒ‰
      $('#txtMatgrp').on('keypress', function (e) {
        if (event.keyCode == 13) {
          page.searchMainData();
        }
      });

      // ì‹ ê·œë²„íŠ¼
      $('#btnNew').click(function (e) {

        $('#CapAnalysisForm')[0].reset();
        $('#CapAnalysisForm').find('#id').val('');

        $('#CapAnalysisForm').find('input, select, textarea').each(function () {
          if ($(this).is(':disabled')) {
            $(this).prop('disabled', false);
          }
        });
      });

      $('#btnSearch').click(function(e){
        page.searchMainData();
      })
      
      $('#btnSave').click(function (e){

        page.save();
          
      });


      $('#btnDel').click(function (e){
        
        page.delete();
      })

      page.searchMainData();
    });

  </script>
</th:block>

</html>