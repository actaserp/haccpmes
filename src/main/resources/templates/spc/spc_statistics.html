<html layout:decorate="~{layout_page}">
<style>
    /* ê¸°ë³¸: ì•ˆë³´ì´ê²Œ */
    #leftWrap .tab-item,
    #rightWrap .tab-item {
        display: none;
    }

    /* activeë§Œ ë³´ì´ê²Œ */
    #leftWrap .tab-item.active,
    #rightWrap .tab-item.active {
        display: block;
    }
    .active-row {
        outline: 2px solid #4c8bf5;
        background: rgba(76, 139, 245, 0.08);
    }

</style>
<th:block layout:fragment="content">
  <div class="layout-contents">

    <div class="page-title-wrap">
      <div class="left">
        <h2>SPCí†µê³„ì ë¶„ì„</h2>
        <a title="ë¶ë§ˆí¬" class="bookmark toggle">
          ë‚´ ë©”ë‰´
        </a>
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>í’ˆì§ˆê´€ë¦¬</li>
        <li>SPCí†µê³„ì ë¶„ì„</li>
      </ul>
    </div>


    <section class="section">
      <div class="section-top">
        <div class="search-wrap">
          <dl>
            <dt>
              ì¡°íšŒ ì¼ì<span class="eq">*</span>
            </dt>
            <dd>
              <ul class="date-box">
                <li>
                  <input type="datetime-local" id="date_from" name="date_from" step="60">
                  <label for="date_from" class="hide">ì‹œì‘ì¼</label>
                </li>
                ~
                <li>
                  <input type="datetime-local" id="date_to" name="date_to" step="60" >
                  <label for="date_to" class="hide">ì¢…ë£Œì¼</label>
                </li>
              </ul>
            </dd>
          </dl>

          <dl>
            <dt>
              <label for="item_name">
                í’ˆëª©ëª…<span class="eq">*</span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <input type="text" id="item_name" style="width: 160px;">
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="processCode">
                ê³µì •<span class="eq">*</span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <select type="text" id ="processCode" style="width: 160px;"></select>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="measure_code">
                ì¸¡ì •í•­ëª©<span class="eq">*</span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <select type="text" id="measure_code" style="width: 160px;"></select>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="recipe">
                ë ˆì‹œí”¼ëª…<span class="eq">*</span>
              </label>
            </dt>
            <dd>
              <div class="srch-box">
                <input type="text" id="recipe" style="width: 160px;">
              </div>
            </dd>
          </dl>
          <dl>
            <dt>&nbsp;</dt>
            <dd>
              <li>
                <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnMainSearch">
                  <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                  <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                  ê²€ìƒ‰
                </a>
              </li>
            </dd>
          </dl>
        </div>
      </div>

      <h4 style=" margin-top: 10px;">ê´€ë¦¬ê¸°ì¤€</h4>
      <div id="analysisMeta"
           style="display:flex; gap:14px; flex-wrap:wrap; align-items:center;
            padding:8px 10px; border:1px solid #e6e6e6; border-radius:10px; background:#fafafa; margin:6px 0 10px;">
        <span><b>ê³µì •(ì„¤ë¹„)</b>: <span id="metaProcess">-</span></span>
        <span><b>ì¸¡ì •í•­ëª©</b>: <span id="metaMeasure">-</span></span>
        <span><b>ë ˆì‹œí”¼</b>: <span id="metaRecipe">-</span></span>
        <span><b>í’ˆëª©</b>: <span id="metaItem">-</span></span>
      </div>
      <table class="write-table" style="width: 100%; border-collapse: collapse;">
        <caption style="text-align: left; margin-bottom: 8px;">ê´€ë¦¬ê¸°ì¤€ ìƒì„¸í…Œì´ë¸”</caption>
        <input type="hidden" class="form-control2" id="spc_std_id" name="spc_std_id" readonly disabled/>
        <tbody>
        <tr>
          <th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;">
            <label for="targetValue">Target:</label>
          </th>
          <td>
            <input id="targetValue" name="targetValue" style="width:100%;" readonly>
          </td>

          <th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;" readonly>
            <label>USL/LSL:</label>
          </th>
          <td colspan="4">
            <div style="display:flex; align-items:center; gap:6px;">
              <input type="text" id="usl" name="usl" style="width:100%;" readonly>
              <span>/</span>
              <input type="text" id="lsl" name="lsl" style="width:100%;" readonly>
              <!-- í•„ìš”í•˜ë©´ ë‹¨ìœ„ í‘œì‹œ -->
              <!-- <span>â„ƒ</span> -->
            </div>
          </td>

          <th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;">
            <label>UCL/LCL:</label>
          </th>
          <td colspan="2">
            <div style="display:flex; align-items:center; gap:6px;">
              <input type="text" id="ucl" name="ucl" style="width:100%;" readonly>
              <span>/</span>
              <input type="text" id="lcl" name="lcl" style="width:100%;" readonly>
              <!-- <span>â„ƒ</span> -->
            </div>
          </td>

          <th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;">
            <label for="sampleSize">ìƒ˜í”Œìˆ˜(n):</label>
          </th>
          <td colspan="2">
            <input type="text" id="sampleSize" name="sampleSize" style="width:100%;" readonly>
          </td>

          <th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;">
            <label for="measure_cycle_value">ì¸¡ì •ì£¼ê¸°:</label>
          </th>
          <td colspan="2">
            <div style="display:flex; align-items:center; gap:6px;">
              <input type="text" id="measure_cycle_value" name="measure_cycle_value" style="width:100%;" readonly>
            </div>
          </td>
        </tr>
        </tbody>
      </table>

      <h4 style=" margin-top: 10px;">ë¶„ì„ì§€í‘œ ìš”ì•½ KPI</h4>
      <table class="write-table" style="width: 100%; border-collapse: collapse;">
        <caption style="text-align: left; margin-bottom: 8px;">ìƒì„¸í…Œì´ë¸”</caption>
        <input type="hidden" class="form-control2" id="id" name="id" readonly disabled/>
        <tbody>
        <tr>
          <th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;">
            <label for="master_grp">í‰ê· (Mean)</label>
          </th>
          <td>
            <input id="master_grp" name="master_grp" style="width:100%;" readonly>
          </td>

          <th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;">
            <label for="master_name">í‘œì¤€í¸ì°¨(Ïƒ)</label>
          </th>
          <td colspan="2">
            <input type="text" id="master_name" name="master_name" style="width:100%;" readonly>
          </td>

          <th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;">
            <label>ìµœì†Œ/ìµœëŒ€</label>
          </th>
          <td colspan="2">
            <input style="width:100%;" id="minMax" name="minMax" readonly>
          </td>

          <th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;">
            <label>ìƒ˜í”Œìˆ˜(N)</label>
          </th>
          <td>
            <input style="width:100%;" id="sampleCountN" name="sampleCountN" readonly>
          </td>

          <th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;">
            <label>ì´ìƒì (í•œê³„ì´ˆê³¼)</label>
          </th>
          <td>
            <input style="width:100%;" id="outOfLimitCount" name="outOfLimitCount" readonly>
          </td>

          <!--<th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;">
            <label>CPK</label>
          </th>
          <td colspan="2">
            <input style="width:100%;" id="cpk" name="cpk" readonly>
          </td>-->

          <!--<th style="text-align:center; width:7%; padding:5px; border:1px solid #ddd;">
            <label>ì¸¡ì •ì£¼ê¸°</label>
          </th>
          <td colspan="2">
            <input style="width:100%;" id="measureCycleKpi" name="measureCycleKpi" readonly>
          </td>-->
        </tr>
        </tbody>
      </table>

      <h4 style=" margin-top: 10px;">ì¸¡ì •ê°’</h4>
      <div style="display:flex; gap:20px; width:100%; max-height:415px; ">

        <!-- LEFT -->
        <div class="tab-wrap" id="leftWrap" style="width:50%; min-width:0;">
          <ul class="tab-links">
            <li class="active"><a href="#L_tabBasic">ì¸¡ì •ê°’</a></li>
            <li><a href="#L_tabChasu">ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸</a></li>
          </ul>

          <!-- ì¸¡ì •ê°’ íƒ­ -->
          <section class="tab-item active" id="L_tabBasic">

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
              <h5 style="margin:0;">ì›ì²œ ì¸¡ì •ê°’(ë¡œê·¸ ê¸°ë°˜)</h5>
            </div>

            <table class="write-table" style="width:100%;">
              <thead>
              <tr>
                <th style="width:110px;">ì¼ì‹œ</th>
                <th id="valueHeader" style="width:90px; text-align:right;">ê°’</th>
                <th style="width:140px;">UCL/LCL íŒì •</th>
                <th>ë¹„ê³ </th>
              </tr>
              </thead>
              <tbody id="rawLogTableBody"><!-- JSë¡œ ì±„ì›€ --></tbody>
            </table>
          </section>

          <!-- ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸ íƒ­ -->
          <section class="tab-item" id="L_tabChasu"  style="flex:1; min-width:240px; border-radius:14px;">

            <!-- 6) ì•ŒëŒ íƒ€ì„ë¼ì¸ -->
              <h5 style="margin-bottom:2px;">ì•ŒëŒ / ì´ìƒ ì¡°ì§ íƒ€ì„ë¼ì¸</h5>

              <div id="eventTimeline"><!-- JSë¡œ ì±„ì›€ --></div>

          </section>
        </div>

        <!-- RIGHT -->
        <div class="tab-wrap" id="rightWrap" style="width:50%; min-width:0;">
          <ul class="tab-links">
            <li class="active"><a href="#R_tabHist">Histogram with USL/LSL</a></li>
            <li><a href="#R_tabI">ê´€ë¦¬ë„ I (ì¸¡ì •ê°’)</a></li>
            <li><a href="#R_tabMr">ê´€ë¦¬ë„ MR (ë³€ë™)</a></li>
            <li><a href="#R_tabBox">Box Plot</a></li>
          </ul>

          <!-- Histogram -->
          <section class="tab-item active" id="R_tabHist">
            <h5 style="margin:6px 0;">Histogram with USL/LSL</h5>
            <div style="height:260px; position:relative;">
              <canvas id="histChart"></canvas>
            </div>
            <div id="histSummary" style="margin-top:6px; color:#666; font-size:12px;"></div>
          </section>

          <!-- I-MR -->
          <!--<section class="tab-item" id="R_tabImr">
            <h5 style="margin:6px 0;">ê´€ë¦¬ë„ I-MR</h5>
            <div style="height:260px; position:relative;">
              <canvas id="imrChart"></canvas>
            </div>
            <div id="imrSummary" style="margin-top:6px; color:#666; font-size:12px;"></div>
          </section>-->
          <!-- I Chart -->
          <section class="tab-item" id="R_tabI">
            <h5 style="margin:6px 0;">ê´€ë¦¬ë„ I (ì¸¡ì •ê°’)</h5>
            <div style="height:260px; position:relative;">
              <canvas id="iChart"></canvas>
            </div>
            <div id="iSummary" style="margin-top:6px; color:#666; font-size:12px;"></div>
          </section>

          <!-- MR Chart -->
          <section class="tab-item" id="R_tabMr">
            <h5 style="margin:6px 0;">ê´€ë¦¬ë„ MR (ë³€ë™)</h5>
            <div style="height:260px; position:relative;">
              <canvas id="mrChart"></canvas>
            </div>
            <div id="mrSummary" style="margin-top:6px; color:#666; font-size:12px;"></div>
          </section>


          <!-- Box Plot -->
          <section class="tab-item" id="R_tabBox">
            <h5 style="margin:6px 0;">Box Plot</h5>
            <div style="height:260px; position:relative;">
              <canvas id="boxChart"></canvas>
            </div>
            <div id="boxSummary" style="margin-top:6px; color:#666; font-size:12px;"></div>
          </section>
        </div>

      </div>
    </section>

  </div>
</th:block>

<th:block layout:fragment="scripts">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot@4.4.4/build/index.umd.min.js"></script>
  <script type="text/javascript">
   (function registerBoxPlot(){
    const mod = window.ChartBoxPlot || window['chartjs-chart-boxplot'] || null;
    if (!mod || !window.Chart || !Chart.register) return;

    Object.keys(mod).forEach(k => {
     const v = mod[k];
     // Chart.js register ê°€ëŠ¥í•œ ê²ƒ(Controller/Scale/Element/Plugin ë“±)ë§Œ ë“±ë¡ ì‹œë„
     try { Chart.register(v); } catch(e) {}
    });
   })();

   class SPCStatisticsPage {
    constructor() {
     this.baseUrl = '/api/spc/SPCStatistics';
     this.urlSpcList = this.baseUrl + '/spcList';

     this._histChart = null;
     this._imrChart = null;
     this._boxChart = null;

     this.loading = false;
     this._lastSpcPayload = null;

     this.init();
    }

    init() {
     //ê³µì •ì½”ë“œ
     const $p = $('#processCode');

     AjaxUtil.fillSelectOptions($p, 'process', '', '', '');

// 41/43ë§Œ ë‚¨ê¸°ê¸°
     const allowProc = new Set(['41', '43']);
     $p.find('option').each(function () {
      const v = String($(this).val());
      if (v !== '' && !allowProc.has(v)) $(this).remove();
     });

    // ê¸°ë³¸ ê³µì • ì„ íƒ
     $p.val('43').change();

    // ê³µì • ë³€ê²½ ì‹œ ì¸¡ì •í•­ëª© ë‹¤ì‹œ ë¡œë“œ
     $p.off('change.spc').on('change.spc', function () {
      const procCode = String($(this).val());
      fillMeasureByProcess(procCode, ''); // í•„ìš”í•˜ë©´ ì´ì „ ì„ íƒê°’ ë„£ê¸°
     });

    // ìµœì´ˆ 1íšŒ
     fillMeasureByProcess('43', '');

    }//init


    // âœ… ë¡œê·¸ API í˜¸ì¶œ
    searchMainData() {
     const _this = this;

     if (_this.loading) return;
     _this.loading = true;

     const data = {
      date_from: $('#date_from').val(),
      date_to: $('#date_to').val(),
      item_name: $('#item_name').val(),
      process_cd: $('#processCode').val(),
      measure_code: $('#measure_code').val(),
      recipe: $('#recipe').val(),
      action: 'read'
     };

     AjaxUtil.getAsyncData(_this.urlSpcList, data,
      function (result) {
       _this.loading = false;

       if (!result || result.success !== true) {
        const last = _this._lastSpcPayload || null;
        if (last) _this.renderSpc(last);
        else _this.renderEmptyRawLog(result?.message || 'ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
       }

       const payload = result.data ?? result;
       _this._lastSpcPayload = payload;

       _this.bindSpecToForm(payload);
       _this.bindKpiToForm(payload);
       _this.renderSpc(payload);
      },
      function (err) {
       _this.loading = false;
       console.error('spcList api error', err);

       const last = _this._lastSpcPayload || null;
       if (last) _this.renderSpc(last);
       else _this.renderEmptyRawLog('ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
     );
    }

    bindSpecToForm(payload) {
     if (!payload) return;

     const spec = payload.spec || payload; // í˜¹ì‹œ ì˜ˆì „ í˜•íƒœë„ ê°™ì´ ëŒ€ì‘

     $('#targetValue').val(spec.target_value ?? spec.target ?? '');
     $('#usl').val(spec.usl ?? '');
     $('#lsl').val(spec.lsl ?? '');
     $('#ucl').val(spec.ucl ?? '');
     $('#lcl').val(spec.lcl ?? '');

     $('#sampleSize').val(spec.sample_size ?? spec.sampleSize ?? '');

     const cycleValue = spec.measure_cycle_value ?? spec.measureCycleValue ?? '';
     const cycleUnit  = spec.measure_cycle_unit_name ?? ''; // "MIN"
     const cycleText  = (cycleValue && cycleUnit) ? `${cycleValue} ${cycleUnit}` : (cycleValue || '');
     $('#measure_cycle_value').val(cycleText);
    }

    bindKpiToForm(payload) {
     if (!payload) return;

     // âœ… Capability ìŠ¤íƒ€ì¼( spec/kpi ) ìš°ì„ , ì—†ìœ¼ë©´ ê¸°ì¡´ flatë„ fallback
     const spec = payload.spec || payload;
     const kpi  = payload.kpi  || payload;

     // KPI ê°’
     const mean = this._toNum(kpi.mean);
     const std  = this._toNum(kpi.std ?? kpi.sigmaWithin ?? kpi.sigmaOverall);
     const min  = this._toNum(kpi.min);
     const max  = this._toNum(kpi.max);
     const n    = kpi.n ?? kpi.sampleCount ?? '';

     // ì´ìƒì (í•œê³„ì´ˆê³¼)
     // - spcList í†µì¼ì•ˆ: limitOverCount
     // - capability: oosCount(ê·œê²©ì´ˆê³¼)
     const out = kpi.limitOverCount ?? kpi.oosCount ?? kpi.outOfLimitCount ?? '';

     // CPK
     const cpk = kpi.cpk ?? '';

     // ì¸¡ì •ì£¼ê¸°(ê´€ë¦¬ê¸°ì¤€ì—ì„œ)
     const cycleValue = spec.measure_cycle_value ?? spec.measureCycleValue ?? '';
     const cycleUnit  = spec.measure_cycle_unit_name   ?? '';
     const cycleText  = (cycleValue && cycleUnit) ? `${cycleValue} ${cycleUnit}` : (cycleValue || '');

     // âœ… í¼ ë°”ì¸ë”©
     $('#master_grp').val(mean == null ? '' : this._fmt(mean, 3));
     $('#master_name').val(std  == null ? '' : this._fmt(std, 3));

     $('#minMax').val((min == null || max == null) ? '' : `${this._fmt(min)} / ${this._fmt(max)}`);
     $('#sampleCountN').val(n);

     $('#outOfLimitCount').val(out);

     const cpkNum = this._toNum(cpk);
     $('#cpk').val(cpkNum == null ? '' : this._fmt(cpkNum, 3));

     $('#measureCycleKpi').val(cycleText);
    }

    // âœ… ë¹ˆ í™”ë©´ ì²˜ë¦¬
    renderEmptyRawLog(message) {
     $('#rawLogTableBody').html(
      `<tr><td colspan="4" style="text-align:center; color:#888; padding:12px;">${message || 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'}</td></tr>`
     );
     $('#eventTimeline').html(`<div style="color:#888; padding:6px 0;">ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`);

     $('#histSummary').text('');
     //$('#imrSummary').text('');
     $('#boxSummary').text('');

     $('#iSummary').text('');     // âœ… ì¶”ê°€
     $('#mrSummary').text('');    // âœ… ì¶”ê°€

     this._destroyCharts();
    }

    // âœ… payload => í…Œì´ë¸”/íƒ€ì„ë¼ì¸/ì°¨íŠ¸ ë Œë”
    renderSpc(payload) {
     const rows = Array.isArray(payload?.rows) ? payload.rows : [];
     if (rows.length === 0) {
      this.renderEmptyRawLog(payload?.message || 'ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
     }

     const spec = payload.spec || {};
     const kpi  = payload.kpi  || {};

     const unit = payload.unit || spec.unit_name || '';

     const mean = this._toNum(kpi.mean);
     const std  = this._toNum(kpi.std);
     const n    = kpi.n ?? rows.length;

     // âœ… ê·œê²©í•œê³„(USL/LSL)
     const usl = this._toNum(spec.usl);
     const lsl = this._toNum(spec.lsl);

     // âœ… ê´€ë¦¬í•œê³„(UCL/LCL)ë„ ë‚´ë ¤ì£¼ë©´ ê·¸ê±¸ ì“°ëŠ” ê²Œ ì •ì„
     const ucl = this._toNum(spec.ucl);
     const lcl = this._toNum(spec.lcl);

     const processText = $('#processCode option:selected').text() || payload.process_name || spec.process_name || '-';
     const measureText = $('#measure_code option:selected').text() || payload.measure_name || spec.measure_name || '-';

     const recipeText  =
      ($('#recipe').val() || '').trim()
      || payload.recipe
      || spec.recipe
      || rows[0]?.recipe
      || rows[0]?.file_name
      || rows[0]?.fileName
      || '-';

     const itemText =
      ($('#item_name').val() || '').trim()
      || payload.item_name
      || spec.item_name
      || '-';

     $('#metaProcess').text(processText);
     $('#metaMeasure').text(measureText);
     $('#metaRecipe').text(recipeText);
     $('#metaItem').text(itemText);

     $('#valueHeader').text(unit ? `ê°’(${unit})` : 'ê°’');

     // LEFT: judge ê¸°ì¤€ì„ ë­˜ë¡œ í• ì§€ ê²°ì •
     // - "ê·œê²© ì´ˆê³¼"ë¥¼ ë³´ê³  ì‹¶ìœ¼ë©´ usl/lsl
     // - "ê´€ë¦¬í•œê³„ ì´ˆê³¼"ë¥¼ ë³´ê³  ì‹¶ìœ¼ë©´ ucl/lcl
     // ë³´í†µ SPC í™”ë©´ì—ì„œëŠ” UCL/LCL(ê´€ë¦¬í•œê³„)ì´ ë§ìŠµë‹ˆë‹¤.
     this._renderRawTable(rows, { ucl, lcl });
     this._renderTimeline(rows, { ucl, lcl });

     // RIGHT
     const values = rows.map(r => this._toNum(r.value)).filter(v => v != null);
     const labels = rows.map(r => this._fmtTime(r.time));

     this._drawHistogram(values, {
      usl: spec.usl,
      lsl: spec.lsl,
      target: spec.target_value ?? spec.target,
      mean: kpi.mean,
      std: kpi.std,
      unit,
      metricName: spec.measure_name || payload.measure_name
     });

     // I-MRì€ ë‚´ë¶€ì—ì„œ í•œê³„ ê³„ì‚°í•˜ë‹ˆ meanë§Œ ìˆìœ¼ë©´ ë˜ì§€ë§Œ,
     // ê·œê²©ì„ (USL/LSL)ì„ ê°™ì´ ë³´ì—¬ì£¼ë ¤ë©´ usl/lsl ë„˜ê¸°ëŠ” ê±´ OK
     // this._drawIMR(values, labels, { mean, usl, lsl, unit });
     this._drawIChart(values, labels, {
      mean,
      target: spec.target_value ?? spec.target,
      ucl, lcl,
      unit
     });

     this._drawMRChart(values, labels, { mean, unit });

     this._drawBoxPlot(values, { unit });

     $('#histSummary').text(`N=${n} / í‰ê· =${this._fmt(mean)} / í‘œì¤€í¸ì°¨=${this._fmt(std)}`);
     $('#imrSummary').text(`I-MR: í‰ê· =${this._fmt(mean)} / (I-UCL/LCLì€ MRbar ê¸°ë°˜)`);
     $('#boxSummary').text(`Box: ì¤‘ì•™ê°’/ì‚¬ë¶„ìœ„ ê¸°ë°˜(ë¶„í¬ í™•ì¸ìš©)`);
    }

    // âœ… "2026-01-29 ì˜¤ì „ 06:58:26" -> timestamp(ms)
    _toMs(t) {
     if (t == null) return NaN;
     if (typeof t === 'number') return t;

     const s = String(t).trim();
     const m = s.match(/^(\d{4}-\d{2}-\d{2})\s+(ì˜¤ì „|ì˜¤í›„)\s+(\d{1,2}):(\d{2}):(\d{2})$/);
     if (m) {
      const date = m[1];
      const ampm = m[2];
      let hh = parseInt(m[3], 10);
      const mm = m[4];
      const ss = m[5];

      if (ampm === 'ì˜¤ì „') {
       if (hh === 12) hh = 0;
      } else {
       if (hh !== 12) hh += 12;
      }
      return new Date(`${date}T${String(hh).padStart(2, '0')}:${mm}:${ss}`).getTime();
     }

     const ms = Date.parse(s);
     return Number.isNaN(ms) ? NaN : ms;
    }

    // âœ… í…Œì´ë¸”/íƒ€ì„ë¼ì¸ ì—°ê²°ìš© ê³ ìœ í‚¤
    _rowKey(r) {
     // timeì´ ê°€ì¥ ì•ˆì •ì ì´ë¼ time ê¸°ì¤€ + ê°’(ë™ì¼ì‹œê° ì¤‘ë³µ ëŒ€ë¹„)
     return `${r?.time ?? ''}__${r?.value ?? ''}`;
    }

    // ---------- LEFT: í…Œì´ë¸” ----------
    _renderRawTable(rows, { ucl, lcl }) {
     const $tb = $('#rawLogTableBody').empty();
     if (!Array.isArray(rows) || rows.length === 0) return;

     // âœ… ìµœì‹ ìˆœ DESC
     const sortedRows = [...rows].sort((a, b) => {
      const ta = this._toMs(a.time);
      const tb = this._toMs(b.time);
      if (Number.isNaN(ta) && Number.isNaN(tb)) return 0;
      if (Number.isNaN(ta)) return 1;
      if (Number.isNaN(tb)) return -1;
      return tb - ta;
     });

     sortedRows.forEach((r) => {
      const t = this._fmtTime(r.time);
      const v = this._toNum(r.value);
      const memo = (r.memo ?? '').toString();

      // âœ… ê´€ë¦¬í•œê³„ íŒì •(í•œìª½ë§Œ ìˆì–´ë„ OK)
      let judge = (r.judge ?? '').toString();
      if (v != null) {
       const overUcl  = (ucl != null && v > ucl);
       const underLcl = (lcl != null && v < lcl);
       judge = (overUcl || underLcl) ? 'ì´ìƒ' : 'ì •ìƒ';
      }

      const badge = (judge === 'ì´ìƒ')
       ? `<span style="display:inline-block; padding:2px 8px; border-radius:10px; background:#ffe8e8; color:#b00020; font-size:12px;">ì´ìƒ</span>`
       : `<span style="display:inline-block; padding:2px 8px; border-radius:10px; background:#e9f7ef; color:#1b7f3a; font-size:12px;">ì •ìƒ</span>`;

      const key = this._rowKey(r);

      $tb.append(`
      <tr data-key="${this._escapeHtml(key)}">
        <td style="white-space:nowrap;">${this._escapeHtml(t)}</td>
        <td style="text-align:right;">${v == null ? '-' : this._fmt(v, 3)}</td>
        <td>${badge}</td>
        <td>${this._escapeHtml(memo)}</td>
      </tr>
    `);
     });
    }

    // ---------- LEFT: íƒ€ì„ë¼ì¸(ì´ìƒì ë§Œ) ----------
    _renderTimeline(rows, { ucl, lcl }) {
     const $t = $('#eventTimeline').empty();
     if (!Array.isArray(rows) || rows.length === 0) {
      $t.html(`<div style="color:#888; padding:6px 0;">ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`);
      return;
     }

     // âœ… ì´ìƒ ì´ë²¤íŠ¸ ìˆ˜ì§‘ (UCL/LCL í•œìª½ë§Œ ìˆì–´ë„ ë™ì‘)
     const events = [];
     rows.forEach((r) => {
      const v = this._toNum(r.value);
      if (v == null) return;

      const overUcl  = (ucl != null && v > ucl);
      const underLcl = (lcl != null && v < lcl);
      if (!(overUcl || underLcl)) return;

      events.push({
       key: this._rowKey(r),
       time: r.time,
       value: v,
       type: 'ì´ìƒ'
      });
     });

     if (events.length === 0) {
      $t.html(`<div style="color:#888; padding:6px 0;">ì´ìƒ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`);
      return;
     }

     // âœ… íƒ€ì„ë¼ì¸ë„ ìµœì‹ ìˆœ DESC
     events.sort((a, b) => {
      const ta = this._toMs(a.time);
      const tb = this._toMs(b.time);
      if (Number.isNaN(ta) && Number.isNaN(tb)) return 0;
      if (Number.isNaN(ta)) return 1;
      if (Number.isNaN(tb)) return -1;
      return tb - ta;
     });

     // âœ… ë Œë”
     events.forEach(ev => {
      $t.append(`
      <div class="timeline-item" data-key="${this._escapeHtml(ev.key)}"
           style="padding:6px 10px; border:1px solid #eee; border-radius:10px; margin:6px 0; cursor:pointer;">
        <div style="font-size:12px; color:#666;">${this._escapeHtml(this._fmtTime(ev.time))}</div>
        <div style="font-weight:600; color:#b00020;">[${ev.type}] ê°’: ${this._fmt(ev.value, 3)}</div>
      </div>
    `);
     });

     // âœ… í´ë¦­ ì‹œ í…Œì´ë¸”ì˜ ê°™ì€ rowKeyë¡œ ì´ë™/ê°•ì¡°
     $t.off('click').on('click', '.timeline-item', (e) => {
      const key = String($(e.currentTarget).data('key') ?? '');
      const $row = $(`#rawLogTableBody tr[data-key="${CSS.escape(key)}"]`);

      if ($row.length) {
       $row.addClass('active-row');
       $row.siblings().removeClass('active-row');
       $row[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
     });
    }

    // ---------- RIGHT: Histogram ----------
    _drawHistogram(values, { usl, lsl, target, mean, std, unit, metricName }) {
     const ctx = document.getElementById('histChart');
     if (!ctx) return;

     if (this._histChart) { this._histChart.destroy(); this._histChart = null; }
     if (!values || !values.length) return;

     // âœ… bins
     const min = Math.min(...values);
     const max = Math.max(...values);
     const k = Math.max(5, Math.ceil(Math.log2(values.length) + 1));
     const binW = (max - min) / k || 1;

     const bins = new Array(k).fill(0);
     for (const v of values) {
      let idx = Math.floor((v - min) / binW);
      if (idx >= k) idx = k - 1;
      if (idx < 0) idx = 0;
      bins[idx]++;
     }

     // âœ… bin ì¤‘ì‹¬ê°’(ì •ê·œë¶„í¬ ê³¡ì„  Xì¢Œí‘œë¡œ ì‚¬ìš©)
     const centers = bins.map((_, i) => min + (i + 0.5) * binW);

     // âœ… xì¶• ë¼ë²¨ì€ ë„ˆë¬´ ê¸¸ë©´ ê°€ë…ì„± ë–¨ì–´ì ¸ì„œ ê°„ë‹¨íˆ
     const labels = bins.map((_, i) => {
      const a = min + i * binW;
      const b = a + binW;
      return `${this._fmt(a, 2)}~${this._fmt(b, 2)}`;
     });

     // âœ… ì •ê·œë¶„í¬ ê³¡ì„ (ë¹ˆë„ ìŠ¤ì¼€ì¼ì— ë§ì¶¤)
     // pdf(x)= 1/(std*sqrt(2pi))*exp(-(x-mean)^2/(2std^2))
     // ë¹ˆë„ ë§ì¶”ê¸° ìœ„í•´ N*binW ê³±í•¨ (ì´ê²Œ íˆìŠ¤í† ê·¸ë¨ ìŠ¤ì¼€ì¼ë§ ì •ì„)
     const N = values.length;
     const pdfToCount = (x) => {
      if (!std || std <= 0 || mean == null) return null;
      const z = (x - mean) / std;
      const pdf = (1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * z * z);
      return pdf * N * binW;
     };

     const normalCurve = centers.map(c => pdfToCount(c));

     // âœ… Cpk ê³„ì‚°(ê°€ëŠ¥í•  ë•Œë§Œ)
     const cpk = (() => {
      if (mean == null || std == null || std <= 0) return null;
      if (usl == null && lsl == null) return null;
      const cpu = (usl != null) ? (usl - mean) / (3 * std) : null;
      const cpl = (lsl != null) ? (mean - lsl) / (3 * std) : null;
      if (cpu == null) return cpl;
      if (cpl == null) return cpu;
      return Math.min(cpu, cpl);
     })();

     // âœ… ìˆ˜ì§ì„  í”ŒëŸ¬ê·¸ì¸: LSL/USL/MEAN/TARGET
     const vlinePlugin = {
      id: 'vlinePluginHist',
      afterDraw: (chart) => {
       const { ctx, chartArea } = chart;

       const toX = (val) => {
        if (val == null) return null;
        const ratio = (val - min) / (max - min || 1);
        return chartArea.left + ratio * (chartArea.right - chartArea.left);
       };

       const drawLine = (x, text) => {
        if (x == null) return;
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(x, chartArea.top);
        ctx.lineTo(x, chartArea.bottom);
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#999';
        ctx.setLineDash([4, 4]);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = '#666';
        ctx.font = '12px sans-serif';
        ctx.fillText(text, x + 4, chartArea.top + 12);
        ctx.restore();
       };

       drawLine(toX(lsl), 'LSL');
       drawLine(toX(usl), 'USL');
       drawLine(toX(target), 'TARGET');
       drawLine(toX(mean), 'MEAN');
      }
     };

     // âœ… ì°¨íŠ¸ ìƒì„±
     this._histChart = new Chart(ctx, {
      data: {
       labels,
       datasets: [
        // ë§‰ëŒ€(ë¹ˆë„)
        {
         type: 'bar',
         label: unit ? `ë¹ˆë„(${unit})` : 'ë¹ˆë„',
         data: bins
        },
        // ì •ê·œë¶„í¬ ê³¡ì„ (overlay)
        {
         type: 'line',
         label: 'Normal',
         data: normalCurve,
         pointRadius: 0,
         tension: 0.35,
         borderWidth: 2
        }
       ]
      },
      options: {
       responsive: true,
       maintainAspectRatio: false,
       plugins: {
        legend: { display: false },
        tooltip: {
         callbacks: {
          afterBody: () => {
           const parts = [];
           if (mean != null) parts.push(`í‰ê· : ${this._fmt(mean, 2)}`);
           if (std != null) parts.push(`í‘œì¤€í¸ì°¨: ${this._fmt(std, 2)}`);
           if (cpk != null) parts.push(`Cpk: ${this._fmt(cpk, 2)}`);
           return parts.join('\n');
          }
         }
        },
        title: {
         display: true,
         text: metricName ? `${metricName} ë¶„í¬` : 'Histogram'
        }
       },
       scales: {
        x: {
         title: {
          display: true,
          text: unit ? `ì¸¡ì •ê°’ (${unit})` : 'ì¸¡ì •ê°’'
         },
         ticks: { maxRotation: 35, minRotation: 0 }
        },
        y: {
         title: { display: true, text: 'ë¹ˆë„' },
         beginAtZero: true
        }
       }
      },
      plugins: [vlinePlugin]
     });

     // í•„ìš”í•˜ë©´ ì´ ê°’ì„ ë°–ì—ì„œ ì¨ë„ ë¨
     return { cpk };
    }

    // ---------- RIGHT: I-MR (Data-based) ----------
    _calcIMRParams(values, mean) {
     if (!values || values.length < 2) return null;

     const mr = [];
     for (let i = 1; i < values.length; i++) mr.push(Math.abs(values[i] - values[i - 1]));
     const mrBar = mr.reduce((a, b) => a + b, 0) / mr.length;

     const iUcl = mean + 2.66 * mrBar;
     const iLcl = mean - 2.66 * mrBar;
     const mrUcl = 3.268 * mrBar;

     return { mr, mrBar, iUcl, iLcl, mrUcl };
    }
    _drawIChart(values, labels, { mean, target = null, ucl = null, lcl = null, unit } = {}) {
     const ctx = document.getElementById('iChart');
     if (!ctx) return;

     if (this._iChart) { this._iChart.destroy(); this._iChart = null; }
     if (!values || !values.length) return;

     const cleaned = [];
     for (let i = 0; i < values.length; i++) {
      const v = Number(values[i]);
      if (Number.isFinite(v)) cleaned.push({ v, l: labels?.[i] ?? String(i + 1) });
     }
     const xs = cleaned.map(x => x.v);
     const ls = cleaned.map(x => x.l);
     if (xs.length < 2) return;

     const imr = this._calcIMRParams(xs, mean);
     const iUcl = (ucl != null) ? ucl : imr?.iUcl ?? null;
     const iLcl = (lcl != null) ? lcl : imr?.iLcl ?? null;

     const center = (target != null) ? target : mean;

     const pointBg = xs.map(v => {
      const over = (iUcl != null && v > iUcl);
      const under = (iLcl != null && v < iLcl);
      return (over || under) ? 'red' : 'rgba(54, 162, 235, 1)';
     });

     const datasets = [
      { label: unit ? `I(${unit})` : 'I', data: xs, pointRadius: 3, tension: 0,
       pointBackgroundColor: pointBg, pointBorderColor: pointBg },
      { label: (target != null ? 'Target' : 'Mean'), data: xs.map(() => center), pointRadius: 0, borderDash: [6, 4] },
      ...(iUcl != null ? [{ label: 'UCL', data: xs.map(() => iUcl), pointRadius: 0, borderDash: [6, 4] }] : []),
      ...(iLcl != null ? [{ label: 'LCL', data: xs.map(() => iLcl), pointRadius: 0, borderDash: [6, 4] }] : []),
     ];

     this._iChart = new Chart(ctx, {
      type: 'line',
      data: { labels: ls, datasets },
      options: {
       responsive: true,
       maintainAspectRatio: false,
       plugins: {
        legend: { display: true },
        tooltip: {
         callbacks: {
          afterBody: (items) => {
           const v = items?.[0]?.parsed?.y;
           if (!Number.isFinite(v)) return '';
           if (iUcl != null && v > iUcl) return `ğŸ”´ UCL(${iUcl.toFixed(2)}) ì´ˆê³¼`;
           if (iLcl != null && v < iLcl) return `ğŸ”´ LCL(${iLcl.toFixed(2)}) ë¯¸ë§Œ`;
           return '';
          }
         }
        }
       },
       scales: {
        x: { ticks: { autoSkip: true, maxTicksLimit: 8, maxRotation: 0, minRotation: 0 } },
        y: { beginAtZero: false }
       }
      }
     });

     const abnormalCount = xs.filter(v => (iUcl != null && v > iUcl) || (iLcl != null && v < iLcl)).length;
     $('#iSummary').text(`I: ì¤‘ì‹¬=${this._fmt(center)} / UCL=${iUcl != null ? this._fmt(iUcl) : '-'} / LCL=${iLcl != null ? this._fmt(iLcl) : '-'} / ì´ìƒ=${abnormalCount}ê±´`);
    }

    _drawMRChart(values, labels, { mean } = {}) {
     const ctx = document.getElementById('mrChart');
     if (!ctx) return;

     if (this._mrChart) { this._mrChart.destroy(); this._mrChart = null; }
     if (!values || !values.length) return;

     const cleaned = [];
     for (let i = 0; i < values.length; i++) {
      const v = Number(values[i]);
      if (Number.isFinite(v)) cleaned.push({ v, l: labels?.[i] ?? String(i + 1) });
     }
     const xs = cleaned.map(x => x.v);
     const ls = cleaned.map(x => x.l);
     if (xs.length < 2) return;

     const imr = this._calcIMRParams(xs, mean);
     const mr = imr.mr;
     const mrBar = imr.mrBar;
     const mrUcl = imr.mrUcl;

     const mrSeries = [null, ...mr];

     const pointBg = mrSeries.map(v => {
      if (v == null) return 'rgba(0,0,0,0)';
      return (mrUcl != null && v > mrUcl) ? 'red' : 'rgba(153, 102, 255, 1)';
     });

     const datasets = [
      { label: 'MR', data: mrSeries, pointRadius: 3, tension: 0,
       pointBackgroundColor: pointBg, pointBorderColor: pointBg },
      { label: 'MR-CL', data: ls.map((_, i) => (i === 0 ? null : mrBar)), pointRadius: 0, borderDash: [6, 4] },
      { label: 'MR-UCL', data: ls.map((_, i) => (i === 0 ? null : mrUcl)), pointRadius: 0, borderDash: [6, 4] },
     ];

     this._mrChart = new Chart(ctx, {
      type: 'line',
      data: { labels: ls, datasets },
      options: {
       responsive: true,
       maintainAspectRatio: false,
       plugins: {
        legend: { display: true },
        tooltip: {
         callbacks: {
          afterBody: (items) => {
           const v = items?.[0]?.parsed?.y;
           if (!Number.isFinite(v)) return '';
           if (mrUcl != null && v > mrUcl) return `ğŸ”´ MR-UCL(${mrUcl.toFixed(2)}) ì´ˆê³¼`;
           return '';
          }
         }
        }
       },
       scales: {
        x: { ticks: { autoSkip: true, maxTicksLimit: 8, maxRotation: 0, minRotation: 0 } },
        y: { beginAtZero: true }
       }
      }
     });

     const abnormalCount = mr.filter(v => mrUcl != null && v > mrUcl).length;
     $('#mrSummary').text(`MR: MRbar=${this._fmt(mrBar)} / MR-UCL=${this._fmt(mrUcl)} / ì´ìƒ=${abnormalCount}ê±´`);
    }

    /*_drawIMR(values, labels, { mean, usl = null, lsl = null, unit } = {}) {
     const ctx = document.getElementById('imrChart');
     if (!ctx) return;

     if (this._imrChart) { this._imrChart.destroy(); this._imrChart = null; }
     if (!values || !values.length) return;

     // 0) ìˆ«ì ë³´ì • (NaN ì œê±°) + labels ë™ê¸°í™”
     const cleaned = [];
     for (let i = 0; i < values.length; i++) {
      const v = Number(values[i]);
      if (Number.isFinite(v)) cleaned.push({ v, l: labels?.[i] ?? String(i + 1) });
     }
     const xs = cleaned.map(x => x.v);
     const ls = cleaned.map(x => x.l);
     if (xs.length < 2) return;

     // 1) MR ê³„ì‚°
     const mr = [];
     for (let i = 1; i < xs.length; i++) mr.push(Math.abs(xs[i] - xs[i - 1]));
     const mrBar = mr.length ? mr.reduce((a, b) => a + b, 0) / mr.length : null;

     // 2) I ì°¨íŠ¸ ê´€ë¦¬í•œê³„(ì •í†µ I-MR)
     //    I_UCL/LCL = mean Â± 2.66 * MRbar  (moving range size = 2 ê¸°ì¤€)
     const iUcl = (mrBar != null) ? (mean + 2.66 * mrBar) : null;
     const iLcl = (mrBar != null) ? (mean - 2.66 * mrBar) : null;

     // 3) MR ì°¨íŠ¸ í•œê³„
     const mrUcl = (mrBar != null) ? (3.268 * mrBar) : null; // D4=3.268 (n=2)

     // ë¼ì¸ ì‹œë¦¬ì¦ˆ
     const lineMean = xs.map(() => mean);
     const lineIUcl = xs.map(() => iUcl);
     const lineILcl = xs.map(() => iLcl);

     // MRì€ ì²« ì ì´ ì—†ìœ¼ë‹ˆ nullë¡œ íŒ¨ë”©
     const mrSeries = [null, ...mr];
     const mrCL = ls.map((_, i) => (i === 0 ? null : mrBar));
     const mrUCLSeries = ls.map((_, i) => (i === 0 ? null : mrUcl));

     // 4) ì´ìƒì  ìƒ‰ìƒ(ì„ íƒ) - I ì°¨íŠ¸ì—ì„œ í•œê³„ ì´ˆê³¼ ì  í‘œì‹œ
     const pointBg = xs.map(v => {
      if (iUcl != null && v > iUcl) return 'red';
      if (iLcl != null && v < iLcl) return 'red';
      return 'rgba(54, 162, 235, 1)'; // ê¸°ë³¸ìƒ‰ (ì›í•˜ë©´ ì œê±° ê°€ëŠ¥)
     });

     // 5) datasets êµ¬ì„±
     const datasets = [
      {
       label: unit ? `I(${unit})` : 'I',
       data: xs,
       pointRadius: 3,
       tension: 0,
       pointBackgroundColor: pointBg,
       pointBorderColor: pointBg,
      },
      { label: 'I-Mean', data: lineMean, pointRadius: 0, borderDash: [6, 4] },
      { label: 'I-UCL', data: lineIUcl, pointRadius: 0, borderDash: [6, 4] },
      { label: 'I-LCL', data: lineILcl, pointRadius: 0, borderDash: [6, 4] },

      // (ì„ íƒ) ê·œê²©ì„ : USL/LSL
      ...(usl != null ? [{ label: 'USL', data: xs.map(() => usl), pointRadius: 0, borderDash: [2, 2] }] : []),
      ...(lsl != null ? [{ label: 'LSL', data: xs.map(() => lsl), pointRadius: 0, borderDash: [2, 2] }] : []),

      // MR
      { label: 'MR', data: mrSeries, yAxisID: 'y1', pointRadius: 2, tension: 0 },
      { label: 'MR-CL', data: mrCL, yAxisID: 'y1', pointRadius: 0, borderDash: [6, 4] },
      { label: 'MR-UCL', data: mrUCLSeries, yAxisID: 'y1', pointRadius: 0, borderDash: [6, 4] },
     ];

     this._imrChart = new Chart(ctx, {
      type: 'line',
      data: { labels: ls, datasets },
      options: {
       responsive: true,
       maintainAspectRatio: false,
       plugins: {
        legend: { display: true },
        tooltip: {
         callbacks: {
          afterBody: (items) => {
           // I ì°¨íŠ¸ ì´ìƒ ì—¬ë¶€ íˆ´íŒ(ì„ íƒ)
           const v = items?.[0]?.parsed?.y;
           if (!Number.isFinite(v) || iUcl == null || iLcl == null) return '';
           if (v > iUcl) return `âš  ì´ìƒ: I-UCL(${iUcl.toFixed(2)}) ì´ˆê³¼`;
           if (v < iLcl) return `âš  ì´ìƒ: I-LCL(${iLcl.toFixed(2)}) ë¯¸ë§Œ`;
           return '';
          }
         }
        }
       },
       scales: {
        y: { position: 'left', beginAtZero: false },
        y1: { position: 'right', beginAtZero: true, grid: { drawOnChartArea: false } }
       }
      }
     });
    }*/

    // ---------- RIGHT: Box Plot ----------
    _drawBoxPlot(values, { unit }) {
     const ctx = document.getElementById('boxChart');
     if (!ctx) return;

     if (this._boxChart) { this._boxChart.destroy(); this._boxChart = null; }
     if (!values.length) return;

     try {
      this._boxChart = new Chart(ctx, {
       type: 'boxplot',
       data: {
        labels: ['ë¶„í¬'],
        datasets: [{ label: unit ? `Box(${unit})` : 'Box', data: [values] }]
       },
       options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
     } catch (e) {
      $('#boxSummary').text('Box Plot í”ŒëŸ¬ê·¸ì¸ ë¡œë”© ì‹¤íŒ¨(ì½˜ì†” í™•ì¸ í•„ìš”)');
     }
    }

    _destroyCharts() {
     if (this._histChart) { this._histChart.destroy(); this._histChart = null; }
     // if (this._imrChart) { this._imrChart.destroy(); this._imrChart = null; }
     if (this._iChart)   { this._iChart.destroy(); this._iChart = null; }
     if (this._mrChart)  { this._mrChart.destroy(); this._mrChart = null; }
     if (this._boxChart) { this._boxChart.destroy(); this._boxChart = null; }
    }

    _toNum(v) {
     if (v === undefined || v === null || v === '') return null;
     const n = Number(String(v).replaceAll(',', '').trim());
     return Number.isFinite(n) ? n : null;
    }
    _fmt(n, digits = 2) { return n == null ? '-' : Number(n).toFixed(digits); }
    _fmtTime(s) { return s ? String(s).trim() : '-'; }
    _escapeHtml(str) {
     return String(str ?? '')
     .replaceAll('&', '&amp;')
     .replaceAll('<', '&lt;')
     .replaceAll('>', '&gt;')
     .replaceAll('"', '&quot;')
     .replaceAll("'", '&#039;');
    }
   }

   function fillMeasureByProcess(procCode, selectedValue) {
    const $m = $('#measure_code').empty();
    //$m.append($('<option>').val('').text(i18n.getCommonText('ì„ íƒ')));

    // console.log('[fillMeasureByProcess] procCode=', procCode);

    const res = AjaxUtil.getSyncData('/api/spc/SPCStatistics/measureCodes', { process_code: procCode });
    console.log('[measureCodes res]=', res);

    // âœ… ê°€ëŠ¥í•œ í˜•íƒœë¥¼ ì „ë¶€ ì»¤ë²„
    const rows =
     res?.data?.rows
     || res?.data
     || res?.rows
     || [];

    console.log('[measureCodes rows]=', rows);

    rows.forEach(r => {
     $m.append($('<option>').val(r.value).text(r.text));
    });

    if (selectedValue && $m.find(`option[value="${selectedValue}"]`).length) {
     $m.val(selectedValue).change();
    } else if (rows.length > 0) {
     $m.val(rows[0].value).change(); // ì›í•˜ë©´ choose ìœ ì§€ë¡œ ë³€ê²½ ê°€ëŠ¥
    } else {
     $m.val('').change();
    }
   }

   // âœ… date ê¸°ë³¸ê°’(ì˜¤ëŠ˜ 00:00 ~ í˜„ì¬), ê·¸ë¦¬ê³  ì¡°íšŒ ìˆœì„œ ì¤‘ìš”
   function pad2(n){ return String(n).padStart(2,'0'); }
   function toDatetimeLocalValue(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
   }
   function setTodayRangeDefault(){
    const now = new Date();
    const start = new Date(now);
    start.setHours(0,0,0,0);
    if (!$('#date_from').val()) $('#date_from').val(toDatetimeLocalValue(start));
    if (!$('#date_to').val())   $('#date_to').val(toDatetimeLocalValue(now));
   }

   function activateTab($wrap, sel) {
    // íƒ­ ë²„íŠ¼ active
    $wrap.find('.tab-links li').removeClass('active');
    $wrap.find(`.tab-links a[href="${sel}"]`).parent('li').addClass('active');

    // íƒ­ ë‚´ìš© active
    $wrap.find('.tab-item').removeClass('active');
    $wrap.find(sel).addClass('active');
   }

   // âœ… leftWrap/rightWrap ì „ìš© íƒ­ ë°”ì¸ë”© (captureë¡œ ì „ì—­ íƒ­í•¸ë“¤ëŸ¬ ì°¨ë‹¨)
   function bindSpcTabs() {
    ['leftWrap', 'rightWrap'].forEach((id) => {
     const wrapEl = document.getElementById(id);
     if (!wrapEl) return;

     // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
     if (wrapEl.__spcTabsBound) return;
     wrapEl.__spcTabsBound = true;

     wrapEl.addEventListener('click', function (e) {
      const a = e.target.closest('.tab-links a');
      if (!a) return;

      // âœ… ì—¬ê¸°ì„œ ë§‰ì•„ì•¼ ì „ì—­(document) íƒ­í•¸ë“¤ëŸ¬ê°€ ëª» ë°›ìŒ
      e.preventDefault();
      e.stopPropagation();

      const sel = a.getAttribute('href');
      const $wrap = $(wrapEl);

      // ì•ˆì „ì¥ì¹˜
      if ($wrap.find(sel).length === 0) return;

      activateTab($wrap, sel);

      // (ì„ íƒ) ì˜¤ë¥¸ìª½ íƒ­ì¼ ë•Œë§Œ ì°¨íŠ¸ draw/resize
      if (id === 'rightWrap' && window.page?.drawRightTab) {
       requestAnimationFrame(() => window.page.drawRightTab(sel));
      }
     }, true); // âœ… capture = true (í•µì‹¬!)
    });
   }

   $(document).ready(function () {
    bindSpcTabs();
   });

   let page = null;

   $(document).ready(function () {
    setTodayRangeDefault();
    page = new SPCStatisticsPage();
    window.page = page;
    page.searchMainData();

    $('#btnMainSearch').on('click', function () {
     page.searchMainData();
    });
   });

  </script>
</th:block>
</html>
