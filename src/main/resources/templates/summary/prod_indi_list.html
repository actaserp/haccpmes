<html layout:decorate="~{layout_page}">
<th:block layout:fragment="content">
<div class="layout-contents">

    <div class="page-title-wrap">
        <div class="left">
            <h2>ìƒì‚°ëŸ‰ ì§€í‘œ</h2>
            <a title="ë¶ë§ˆí¬" class="bookmark toggle">
                ë‚´ ë©”ë‰´
            </a>
        </div>
        <ul class="page-navi">
            <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
            <li>KPI ì„±ê³¼ ì§€í‘œ</li>
            <li>ìƒì‚°ëŸ‰ ì§€í‘œ</li>
        </ul>
    </div>


    <section class="section">
        <div class="section-top">
            <div class="search-wrap">
                <dl>
                    <dt>
                        <label for="cboYear">
                            ê¸°ì¤€ë…„ë„
                        </label>
                    </dt>
                    <dd>
                        <div class="srch-box">
                            <select id="cboYear">
                            </select>
                        </div>
                    </dd>
                </dl>

                <dl>
                    <dt>&nbsp;</dt>
                    <dd>
                        <li>
                            <a class="btn btn-delete" title="ê²€ìƒ‰" id="btnSearch">
                                <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                ê²€ìƒ‰
                            </a>
                        </li>
                    </dd>
                </dl>
            </div>
        </div>
        <div class="container-fluid">
            <div id="theGrid" style="height: 730px;"></div>
        </div>
    </section>
</div>
</th:block>
<th:block layout:fragment="scripts">
<script type="text/javascript">
    class ProductionMonthPage {
        constructor() {
            this.grid = null;
            this.viewData = new wijmo.collections.CollectionView();
            this.init();
        }

        init() {
            let _this = this;

            this.grid = new wijmo.grid.FlexGrid('#theGrid', {
                selectionMode: wijmo.grid.SelectionMode.Row,
                headersVisibility: wijmo.grid.HeadersVisibility.Column,
                allowSorting: wijmo.grid.AllowSorting.MultiColumn,
                allowMerging: wijmo.grid.AllowMerging.Cells,  //ì…€ ë³‘í•©
                autoGenerateColumns: false,
                showMarquee: true,
                isReadOnly: true,
                frozenColumns: 5,
                formatItem: (sender, e) => {
                    if (e.panel.cellType === wijmo.grid.CellType.ColumnHeader) {
                        e.cell.style.textAlign = 'center';
                    }
                },

                columns: [
                    // { binding: 'mat_type_name', header: 'í’ˆëª©ìœ í˜•', width: 100 ,allowMerging: true },
                    { binding: 'mat_grp_name', header: 'í’ˆëª©ê·¸ë£¹', width: 120 ,allowMerging: true },
                    // { binding: 'mat_code', header: 'í’ˆëª©ì½”ë“œ', width: 150 ,allowMerging: true },
                    { binding: 'mat_name', header: 'í’ˆëª©ëª…', width: '*' , allowMerging: true },
                    // { binding: 'standard1', header: 'ê·œê²©', width: 100, allowMerging: false },
                    { binding: 'unit_name', header: 'ë‹¨ìœ„', width: 100, allowMerging: false },
                    { binding: 'gubn', header: 'êµ¬ë¶„', width: 100, format: 'n0', align: 'right' },
                    ...Array.from({ length: 12 }, (_, i) => ({
                        binding: `mon_${i + 1}`,
                        header: `${i + 1}ì›”`,
                        width: 80,
                        align: 'right',
                        allowSorting: false
                    }))
                ],
                itemsSource: this.viewData, // ë°ì´í„°ë¥¼ ì„¤ì •í•  ë°°ì—´
            });
            this.grid.itemFormatter = function (panel, row, col, cell) {
                if (panel.cellType === wijmo.grid.CellType.Cell) {
                    let colName = panel.columns[col].binding;
                    const rowData = panel.rows[row]?.dataItem;

                    // âœ… ë°˜ë“œì‹œ ë¦¬ì…‹
                    cell.style.fontWeight = '';
                    cell.style.background = '';
                    cell.style.borderBottom = '';

                    if (colName === 'gubn') {
                        const val = panel.getCellData(row, col, true);
                        const label =
                        val === '1' ? 'ìƒì‚°ìˆ˜ëŸ‰' :
                        val === '2' ? 'ì˜ì—…ì¼ìˆ˜' :
                        val === '3' ? 'ì‹œê°„ë‹¹ìƒì‚°ëŸ‰' :
                        val === '4' ? 'ì¹©ìˆ˜' :
                        val === '5' ? 'ìƒì‚°ì¹©ìˆ˜' :
                        val === '6' ? 'ì‹œê°„ë‹¹ì¹©ìƒì‚°ëŸ‰' : '';
                        cell.textContent = label;
                        cell.style.textAlign = 'center';
                    }

                    if (colName.startsWith('mon_') && rowData?.gubn) {
                        let value = panel.getCellData(row, col, false);
                        let gubn = rowData.gubn;

                        if (typeof value === 'number') {
                            cell.textContent = gubn === '3'
                                ? wijmo.Globalize.format(value, 'n2')
                                : wijmo.Globalize.format(value, 'n0');
                        }

                        cell.style.textAlign = 'right';
                    }

                    if (['mat_type_name', 'mat_grp_name', 'mat_code', 'unit_name', 'standard1'].includes(colName)) {
                        cell.style.textAlign = 'center';          // ìˆ˜í‰ ê°€ìš´ë°
                        cell.style.verticalAlign = 'middle';      // ìˆ˜ì§ ê°€ìš´ë°
                        cell.style.display = 'flex';              // flexë¡œ ì •ë ¬
                        cell.style.alignItems = 'center';         // ìˆ˜ì§ ì •ë ¬
                        cell.style.justifyContent = 'center';     // ìˆ˜í‰ ì •ë ¬
                    } else if (['mat_name']){
                        cell.style.textAlign = 'left';
                        cell.style.verticalAlign = 'middle';      // ìˆ˜ì§ ê°€ìš´ë°
                        cell.style.display = 'flex';              // flexë¡œ ì •ë ¬
                        cell.style.alignItems = 'center';         // ìˆ˜ì§ ì •ë ¬
                        cell.style.justifyContent = 'left';     // ìˆ˜í‰ ì •ë ¬
                    }
                    if (
                        rowData &&
                        ['1', '3', '4', '5', '6'].includes(rowData.gubn) &&
                        rowData.mat_grp_name === 'ì „ì²´'
                    ) {
                        cell.style.fontWeight = 'bold';
                        cell.style.background = '#eef3f9';
                        cell.style.borderBottom = '2px solid #444';
                    }

                }
            };
            new FlexGridContextMenu(this.grid);
            this.grid.downloadFileName = 'ìƒì‚°ëŸ‰ ì§€í‘œ';
            this.grid.mergeManager = new CustomMergeManager(this.grid);
        }

        searchMainData() {
            let url = '/api/summary/indicator/prod_read'
            let data = {
				'cboYear' : $("#cboYear").val(),
                'spjangcd' : sessionStorage.getItem('spjangcd')
			}
            const result = AjaxUtil.getSyncData(url, data);
            if (result && result.data) {
                const summaryRows = this.makeSummaryRows(result.data);
                // ğŸ”¥ ìµœìƒë‹¨ì— ê³ ì •
                this.grid.itemsSource = [...summaryRows, ...result.data];
                // ğŸ”¥ ì¨ë¨¸ë¦¬ í–‰ ê°œìˆ˜ë§Œí¼ ìƒë‹¨ ê³ ì •
                this.grid.frozenRows = summaryRows.length;
            }
        }

        makeSummaryRows(data) {
            const rows = [];

            const makeRow = (gubn, label, calcFn) => {
                const row = {
                    __summary: true,   // ğŸ”¥ í•µì‹¬
                    gubn,
                    mat_name: label,
                    mat_grp_name: 'ì „ì²´'
                };

                for (let m = 1; m <= 12; m++) {
                    const key = `mon_${m}`;
                    row[key] = calcFn(key);
                }
                return row;
            };

            // í•´ë‹¹ ì›”ì— ìƒì‚° ìˆì—ˆëŠ”ì§€ íŒë‹¨
            const hasProduction = (data, key) =>
                data.some(r => r.gubn === '1' && (r[key] || 0) > 0);

            // ìƒì‚°ìˆ˜ëŸ‰ í•©ê³„
            rows.push(makeRow('1', 'ìƒì‚°ìˆ˜ëŸ‰ í•©ê³„', key =>
                data.filter(r => r.gubn === '1')
                    .reduce((s, r) => s + (r[key] || 0), 0)
            ));

            // ì‹œê°„ë‹¹ìƒì‚°ëŸ‰ í‰ê· 
            rows.push(makeRow('3', 'ì‹œê°„ë‹¹ìƒì‚°ëŸ‰ í‰ê· ', key => {
                if (!hasProduction(data, key)) return 0;

                const v = data
                    .filter(r => r.gubn === '3')
                    .map(r => r[key])
                    .filter(v => typeof v === 'number');

                return v.length
                    ? +(v.reduce((a,b)=>a+b,0) / v.length).toFixed(2)
                    : 0;
            }));


            // ìƒì‚°ì¹©ìˆ˜ í•©ê³„
            rows.push(makeRow('5', 'ìƒì‚°ì¹©ìˆ˜ í•©ê³„', key =>
                data.filter(r => r.gubn === '5')
                    .reduce((s, r) => s + (r[key] || 0), 0)
            ));

            // ì‹œê°„ë‹¹ì¹©ìƒì‚°ëŸ‰ í‰ê· 
            rows.push(makeRow('6', 'ì‹œê°„ë‹¹ ì¹© ìƒì‚°ëŸ‰ KPI', key => {
                const totalChip = data
                    .filter(r => r.gubn === '5')
                    .reduce((s, r) => s + (r[key] || 0), 0);

                const workday = data.find(r => r.gubn === '2')?.[key] || 0;

                return workday > 0
                    ? +(totalChip / 189 / 13.3).toFixed(2)
                    : 0;
            }));


            return rows;
        }
    }

    let page = null;

    $(document.body).ready(function (e) {
        page = new ProductionMonthPage();

        AjaxUtil.fillSelectOptions($('#cboYear'), 'data_year', '', false);

        page.searchMainData();

        // ê²€ìƒ‰
        $('#btnSearch').click(function (e) {
            page.searchMainData();
        });
    });

    class CustomMergeManager extends wijmo.grid.MergeManager {
        getMergedRange(panel, row, col, clip = true) {
            if (panel.cellType !== wijmo.grid.CellType.Cell) {
                return super.getMergedRange(panel, row, col, clip);
            }

            const colName = panel.columns[col].binding;
            if (colName === 'standard1' || colName === 'unit_name') {
                const matNameCol = panel.columns.getColumn('mat_name').index;
                const val = panel.getCellData(row, col, false);
                const matName = panel.getCellData(row, matNameCol, false);

                let rng = new wijmo.grid.CellRange(row, col);

                // ìœ„ë¡œ ë³‘í•©
                while (rng.row > 0) {
                    let prevVal = panel.getCellData(rng.row - 1, col, false);
                    let prevMatName = panel.getCellData(rng.row - 1, matNameCol, false);
                    if (prevVal !== val || prevMatName !== matName) break;
                    rng.row--;
                }

                // ì•„ë˜ë¡œ ë³‘í•©
                while (rng.row2 < panel.rows.length - 1) {
                    let nextVal = panel.getCellData(rng.row2 + 1, col, false);
                    let nextMatName = panel.getCellData(rng.row2 + 1, matNameCol, false);
                    if (nextVal !== val || nextMatName !== matName) break;
                    rng.row2++;
                }

                return rng.isSingleCell ? null : rng;
            }

            return super.getMergedRange(panel, row, col, clip);
        }
    }



</script>
</th:block>